(()=>{const j=function(){"use strict";const S="woh_library_",t={VERSION:S+"version",PREFERENCES:S+"preferences",PROGRESS:S+"progress",BOOKMARKS:S+"bookmarks",HIGHLIGHTS:S+"highlights",NOTES:S+"notes",HISTORY:S+"history"},$={fontSize:"medium",theme:"auto",viewMode:"translation",showParagraphNumbers:!0,autoSaveProgress:!0};function A(){const r=f(t.VERSION);(!r||r<1)&&(q(r||0),b(t.VERSION,1))}function q(r){console.log(`[LibraryStorage] Migrated from version ${r} to 1`)}function f(r){try{const l=localStorage.getItem(r);return l?JSON.parse(l):null}catch(l){return console.error("[LibraryStorage] Error reading:",r,l),null}}function b(r,l){try{return localStorage.setItem(r,JSON.stringify(l)),!0}catch(u){return console.error("[LibraryStorage] Error writing:",r,u),!1}}function T(r){try{return localStorage.removeItem(r),!0}catch(l){return console.error("[LibraryStorage] Error removing:",r,l),!1}}function v(){const r=f(t.PREFERENCES);return{...$,...r}}function M(r,l){const u=v();return u[r]=l,b(t.PREFERENCES,u)}function G(r){return v()[r]}function B(){return b(t.PREFERENCES,$)}function N(r){return(f(t.PROGRESS)||{})[r]||null}function P(){return f(t.PROGRESS)||{}}function L(r,l){const u=f(t.PROGRESS)||{};return u[r]={...u[r],...l,lastRead:new Date().toISOString()},b(t.PROGRESS,u)}function E(r){const l=f(t.PROGRESS)||{};return delete l[r],b(t.PROGRESS,l)}function _(r){const l=f(t.BOOKMARKS)||{};return r?l[r]||[]:l}function I(r,l,u=""){const g=f(t.BOOKMARKS)||{};g[r]||(g[r]=[]);const y=g[r].find(D=>D.refId===l);return y?(y.note=u,y.updatedAt=new Date().toISOString()):g[r].push({refId:l,note:u,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),b(t.BOOKMARKS,g)}function O(r,l){const u=f(t.BOOKMARKS)||{};return u[r]?(u[r]=u[r].filter(g=>g.refId!==l),b(t.BOOKMARKS,u)):!0}function w(r,l){return _(r).some(g=>g.refId===l)}function H(r){const l=f(t.HIGHLIGHTS)||{};return r?l[r]||[]:l}function x(r,l,u,g){const y=f(t.HIGHLIGHTS)||{};return y[r]||(y[r]=[]),y[r].push({refId:l,color:u,text:g,createdAt:new Date().toISOString()}),b(t.HIGHLIGHTS,y)}function C(r,l){const u=f(t.HIGHLIGHTS)||{};return u[r]?(u[r]=u[r].filter(g=>g.id!==l),b(t.HIGHLIGHTS,u)):!0}function R(r){const l=f(t.NOTES)||{};return r?l[r]||[]:l}function s(r,l,u){const g=f(t.NOTES)||{};g[r]||(g[r]=[]);const y=g[r].find(D=>D.refId===l);return y?(y.content=u,y.updatedAt=new Date().toISOString()):g[r].push({refId:l,content:u,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}),b(t.NOTES,g)}function c(r,l,u){return s(r,l,u)}function p(r,l){const u=f(t.NOTES)||{};return u[r]?(u[r]=u[r].filter(g=>g.refId!==l),b(t.NOTES,u)):!0}function k(r,l){return R(r).find(g=>g.refId===l)||null}function m(r,l,u){const y=(f(t.HISTORY)||[]).filter(z=>z.bookSlug!==r);y.unshift({bookSlug:r,bookTitle:l,lastRefId:u,visitedAt:new Date().toISOString()});const D=y.slice(0,20);return b(t.HISTORY,D)}function i(){return f(t.HISTORY)||[]}function n(){return T(t.HISTORY)}function h(){return{version:1,exportedAt:new Date().toISOString(),preferences:f(t.PREFERENCES),progress:f(t.PROGRESS),bookmarks:f(t.BOOKMARKS),highlights:f(t.HIGHLIGHTS),notes:f(t.NOTES),history:f(t.HISTORY)}}function e(r){if(!r||r.version>1)return console.error("[LibraryStorage] Invalid or newer import data"),!1;try{return r.preferences&&b(t.PREFERENCES,r.preferences),r.progress&&b(t.PROGRESS,r.progress),r.bookmarks&&b(t.BOOKMARKS,r.bookmarks),r.highlights&&b(t.HIGHLIGHTS,r.highlights),r.notes&&b(t.NOTES,r.notes),r.history&&b(t.HISTORY,r.history),!0}catch(l){return console.error("[LibraryStorage] Import error:",l),!1}}function o(){return Object.values(t).forEach(r=>T(r)),!0}function d(){const r=P(),l=_(),u=R();let g=0,y=0,D=Object.keys(r).length;return Object.values(l).forEach(z=>g+=z.length),Object.values(u).forEach(z=>y+=z.length),{booksStarted:D,totalBookmarks:g,totalNotes:y}}return A(),{getPreferences:v,setPreference:M,getPreference:G,resetPreferences:B,getProgress:N,getAllProgress:P,updateProgress:L,clearProgress:E,getBookmarks:_,addBookmark:I,removeBookmark:O,isBookmarked:w,getHighlights:H,addHighlight:x,removeHighlight:C,getNotes:R,addNote:s,updateNote:c,removeNote:p,getNote:k,addToHistory:m,getHistory:i,clearHistory:n,exportData:h,importData:e,clearAllData:o,getStats:d}}();window.LibraryStorage=j;const K=function(){"use strict";const S={fontSizes:{small:"0.875rem",medium:"1rem",large:"1.125rem","x-large":"1.25rem"},themes:["light","sepia","dark"],viewModes:["translation","original","side-by-side"],progressSaveInterval:3e3,scrollDebounceDelay:150};let a={bookSlug:null,bookCode:null,currentChapter:1,currentParagraph:1,totalChapters:1,isInitialized:!1,progressSaveTimeout:null},t={};function $(e={}){if(a.isInitialized)return;const o=document.querySelector(".library-book");if(!o){console.log("[LibraryReader] Not on a book page, skipping init");return}if(a.bookSlug=e.bookSlug||o.dataset.bookSlug||A(),a.bookCode=e.bookCode||o.dataset.bookCode||"",a.totalChapters=document.querySelectorAll(".library-book__chapter").length,q(),f(),G(),R(),x(),window.LibraryStorage){const d=document.querySelector(".library-book__title")?.textContent||a.bookSlug;window.LibraryStorage.addToHistory(a.bookSlug,d,w())}a.isInitialized=!0,console.log("[LibraryReader] Initialized for:",a.bookSlug)}function A(){const o=window.location.pathname.match(/\/library\/([^/]+)/);return o?o[1]:""}function q(){t={container:document.querySelector(".library-book"),content:document.querySelector(".library-book__content"),chapters:document.querySelectorAll(".library-book__chapter"),paragraphs:document.querySelectorAll(".library-book__paragraph"),tocItems:document.querySelectorAll(".library-book__toc-item"),chapterProgress:document.getElementById("chapter-progress"),paragraphProgress:document.getElementById("paragraph-progress"),currentChapterDisplay:document.getElementById("current-chapter-display"),settingsBtn:document.getElementById("reader-settings-btn"),settingsPanel:document.getElementById("reader-settings-panel")}}function f(){if(!window.LibraryStorage)return;const e=window.LibraryStorage.getPreferences();b(e.fontSize,!1),T(e.theme,!1),v(e.viewMode,!1)}function b(e,o=!0){if(!S.fontSizes[e])return;const d=t.content||document.querySelector(".library-book__content");d&&(d.style.setProperty("--reader-font-size",S.fontSizes[e]),d.dataset.fontSize=e),document.querySelectorAll("[data-font-size]").forEach(r=>{r.classList.toggle("active",r.dataset.fontSize===e)}),o&&window.LibraryStorage&&window.LibraryStorage.setPreference("fontSize",e)}function T(e,o=!0){const d=t.container||document.querySelector(".library-book");d&&(S.themes.forEach(r=>d.classList.remove(`library-book--theme-${r}`)),e!=="auto"&&d.classList.add(`library-book--theme-${e}`),d.dataset.readerTheme=e,document.querySelectorAll("[data-reader-theme]").forEach(r=>{r.classList.toggle("active",r.dataset.readerTheme===e)}),o&&window.LibraryStorage&&window.LibraryStorage.setPreference("theme",e))}function v(e,o=!0){const d=document.querySelectorAll(".library-book__text"),r=document.querySelectorAll(".library-book__para-original");d.forEach(y=>{y.classList.remove("library-book__text--split"),e==="side-by-side"&&y.classList.add("library-book__text--split")}),r.forEach(y=>{e==="original"||e==="side-by-side"?y.style.display="block":y.style.display="none"}),document.querySelectorAll(".library-book__para-translation").forEach(y=>{y.style.display=e==="original"?"none":"block"});const u=document.getElementById("original-toggle"),g=document.getElementById("side-by-side-toggle");u&&u.classList.toggle("library-book__btn--active",e==="original"||e==="side-by-side"),g&&(g.classList.toggle("hidden",e==="translation"),g.classList.toggle("library-book__btn--active",e==="side-by-side")),o&&window.LibraryStorage&&window.LibraryStorage.setPreference("viewMode",e)}function M(){const e=window.LibraryStorage?window.LibraryStorage.getPreferences():{viewMode:"translation"},d=(S.viewModes.indexOf(e.viewMode)+1)%S.viewModes.length;v(S.viewModes[d])}function G(){let e;window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>{_(),H()},S.scrollDebounceDelay)},{passive:!0}),document.addEventListener("keydown",B),t.settingsBtn&&t.settingsBtn.addEventListener("click",i),document.querySelectorAll("[data-font-size]").forEach(o=>{o.addEventListener("click",()=>b(o.dataset.fontSize))}),document.querySelectorAll("[data-reader-theme]").forEach(o=>{o.addEventListener("click",()=>T(o.dataset.readerTheme))}),t.paragraphs.forEach(o=>{o.addEventListener("click",()=>{L(o.id)})})}function B(e){if(!e.target.matches("input, textarea, select"))switch(e.key){case"j":N(1);break;case"k":N(-1);break;case"n":P(1);break;case"p":P(-1);break;case"b":s();break;case"o":c();break;case"s":p();break;case"/":e.preventDefault(),k();break;case"Escape":m();break;case"?":e.shiftKey&&n();break}}function N(e){const o=Array.from(t.paragraphs),d=document.querySelector(".library-book__paragraph--selected");let l=(d?o.indexOf(d):-1)+e;l<0&&(l=0),l>=o.length&&(l=o.length-1),o[l]&&(L(o[l].id),o[l].scrollIntoView({behavior:"smooth",block:"center"}))}function P(e){const o=a.currentChapter+e;o>=1&&o<=a.totalChapters&&E(o)}function L(e){t.paragraphs.forEach(d=>d.classList.remove("library-book__paragraph--selected"));const o=document.getElementById(e);if(o){o.classList.add("library-book__paragraph--selected");const d=window.location.pathname+"#"+e;history.replaceState(null,null,d),H()}}function E(e){const o=document.getElementById("chapter-"+e);o&&(o.scrollIntoView({behavior:"smooth",block:"start"}),a.currentChapter=e,I())}function _(){const e=window.scrollY+300;t.chapters.forEach(o=>{const d=o.getBoundingClientRect(),r=d.top+window.scrollY,l=r+d.height;if(e>=r&&e<l){const u=parseInt(o.id.replace("chapter-",""));u!==a.currentChapter&&(a.currentChapter=u,I(),O())}}),t.paragraphs.forEach(o=>{const d=o.getBoundingClientRect(),r=d.top+window.scrollY,l=r+d.height;if(e>=r&&e<l){const u=o.id.match(/^c(\d+)p(\d+)$/);u&&(a.currentParagraph=parseInt(u[2]),I())}})}function I(){if(t.chapterProgress&&(t.chapterProgress.textContent=`Chapter ${a.currentChapter}`),t.paragraphProgress){const e=document.getElementById(`chapter-${a.currentChapter}`),o=e?e.querySelectorAll(".library-book__paragraph").length:0;t.paragraphProgress.textContent=`${a.currentParagraph}/${o}`}t.currentChapterDisplay&&(t.currentChapterDisplay.textContent=`Chapter ${a.currentChapter} of ${a.totalChapters}`)}function O(){t.tocItems.forEach(e=>{const o=parseInt(e.dataset.chapter);e.classList.toggle("library-book__toc-item--active",o===a.currentChapter)})}function w(){return`${a.bookCode}-${a.currentChapter}:${a.currentParagraph}`}function H(){window.LibraryStorage&&(clearTimeout(a.progressSaveTimeout),a.progressSaveTimeout=setTimeout(()=>{window.LibraryStorage.getPreferences().autoSaveProgress&&window.LibraryStorage.updateProgress(a.bookSlug,{chapter:a.currentChapter,paragraph:a.currentParagraph,refId:w(),scrollPosition:window.scrollY})},S.progressSaveInterval))}function x(){if(!window.LibraryStorage)return;const e=window.LibraryStorage.getProgress(a.bookSlug);e&&e.chapter&&!window.location.hash&&C(e)}function C(e){const o=document.createElement("div");o.className="library-reader__continue-prompt",o.innerHTML=`
            <div class="library-reader__continue-content">
                <span class="library-reader__continue-text">
                    Continue from Chapter ${e.chapter}, Paragraph ${e.paragraph}?
                </span>
                <div class="library-reader__continue-actions">
                    <button class="library-reader__continue-btn library-reader__continue-btn--primary" data-action="continue">
                        Continue
                    </button>
                    <button class="library-reader__continue-btn" data-action="dismiss">
                        Start Over
                    </button>
                </div>
            </div>
        `,o.querySelector('[data-action="continue"]').addEventListener("click",()=>{const d=`c${e.chapter}p${e.paragraph}`,r=document.getElementById(d);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>L(d),500)),o.remove()}),o.querySelector('[data-action="dismiss"]').addEventListener("click",()=>{o.remove()}),document.body.appendChild(o),setTimeout(()=>o.remove(),1e4)}function R(){const e=window.location.hash.substring(1);if(e){if(e.includes("-")&&e.includes(":")){const o=e.match(/^(\w+)-(\d+):(\d+)$/);if(o){const[,d,r,l]=o,u=`c${r}p${l}`;setTimeout(()=>{const g=document.getElementById(u);g&&(g.scrollIntoView({behavior:"smooth",block:"center"}),L(u))},300)}}else if(e.match(/^c\d+p\d+$/))setTimeout(()=>{const o=document.getElementById(e);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),L(e))},300);else if(e.startsWith("chapter-")){const o=parseInt(e.replace("chapter-",""));setTimeout(()=>E(o),300)}}}function s(){if(!window.LibraryStorage)return;const e=document.querySelector(".library-book__paragraph--selected");if(!e)return;const o=w();window.LibraryStorage.isBookmarked(a.bookSlug,o)?(window.LibraryStorage.removeBookmark(a.bookSlug,o),e.classList.remove("library-book__paragraph--bookmarked"),h("Bookmark removed")):(window.LibraryStorage.addBookmark(a.bookSlug,o),e.classList.add("library-book__paragraph--bookmarked"),h("Bookmark added"))}function c(){const o=(window.LibraryStorage?window.LibraryStorage.getPreferences():{viewMode:"translation"}).viewMode;v(o==="translation"?"original":o==="original"?"side-by-side":"translation")}function p(){const o=(window.LibraryStorage?window.LibraryStorage.getPreferences():{viewMode:"translation"}).viewMode;o==="side-by-side"?v("original"):o!=="translation"&&v("side-by-side")}function k(){const e=document.getElementById("library-search")||document.getElementById("book-search");e&&e.focus()}function m(){t.settingsPanel&&t.settingsPanel.classList.add("hidden"),t.paragraphs.forEach(e=>e.classList.remove("library-book__paragraph--selected"))}function i(){t.settingsPanel&&t.settingsPanel.classList.toggle("hidden")}function n(){const e=document.createElement("div");e.className="library-reader__shortcuts-modal",e.innerHTML=`
            <div class="library-reader__shortcuts-content">
                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li><kbd>j</kbd> / <kbd>k</kbd> - Next / Previous paragraph</li>
                    <li><kbd>n</kbd> / <kbd>p</kbd> - Next / Previous chapter</li>
                    <li><kbd>b</kbd> - Toggle bookmark</li>
                    <li><kbd>o</kbd> - Toggle original text</li>
                    <li><kbd>s</kbd> - Toggle side-by-side view</li>
                    <li><kbd>/</kbd> - Focus search</li>
                    <li><kbd>Esc</kbd> - Close panels</li>
                    <li><kbd>?</kbd> - Show this help</li>
                </ul>
                <button class="library-reader__shortcuts-close">Close</button>
            </div>
        `,e.addEventListener("click",o=>{(o.target===e||o.target.matches(".library-reader__shortcuts-close"))&&e.remove()}),document.body.appendChild(e)}function h(e,o=2e3){const d=document.querySelector(".library-reader__toast");d&&d.remove();const r=document.createElement("div");r.className="library-reader__toast",r.textContent=e,document.body.appendChild(r),setTimeout(()=>r.classList.add("library-reader__toast--visible"),10),setTimeout(()=>{r.classList.remove("library-reader__toast--visible"),setTimeout(()=>r.remove(),300)},o)}return{init:$,setFontSize:b,setReaderTheme:T,setViewMode:v,cycleViewMode:M,selectParagraph:L,scrollToChapter:E,toggleCurrentBookmark:s,showToast:h,getCurrentRef:w,getState:()=>({...a})}}();document.addEventListener("DOMContentLoaded",()=>{K.init()});window.LibraryReader=K;const V=function(){"use strict";const S={minSearchLength:2,maxResults:100,highlightClass:"library-search__highlight"};let a={bookSlug:null,bookCode:null,isInitialized:!1,searchResults:[],currentResultIndex:-1,searchQuery:""},t={};function $(s={}){if(a.isInitialized)return;const c=document.querySelector(".library-book");if(!c){console.log("[LibrarySearch] Not on a book page");return}a.bookSlug=s.bookSlug||c.dataset.bookSlug||A(),a.bookCode=s.bookCode||c.dataset.bookCode||"",q(),f(),b(),H(),a.isInitialized=!0,console.log("[LibrarySearch] Initialized for:",a.bookSlug)}function A(){const c=window.location.pathname.match(/\/library\/([^/]+)/);return c?c[1]:""}function q(){const s=document.querySelector(".library-book__controls");if(!s)return;const c=document.createElement("div");c.className="library-search",c.innerHTML=`
            <div class="library-search__input-wrapper">
                <svg class="library-search__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="library-book-search"
                       class="library-search__input"
                       placeholder="Search or go to (e.g. 1:5)..."
                       autocomplete="off">
                <button class="library-search__clear hidden" id="search-clear" aria-label="Clear search">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="library-search__nav hidden" id="search-nav">
                <span class="library-search__count" id="search-count">0/0</span>
                <button class="library-search__nav-btn" id="search-prev" aria-label="Previous result">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                </button>
                <button class="library-search__nav-btn" id="search-next" aria-label="Next result">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"></path>
                    </svg>
                </button>
            </div>
        `;const p=s.querySelector(".library-book__progress");p?s.insertBefore(c,p):s.prepend(c)}function f(){t={searchInput:document.getElementById("library-book-search"),clearBtn:document.getElementById("search-clear"),searchNav:document.getElementById("search-nav"),searchCount:document.getElementById("search-count"),prevBtn:document.getElementById("search-prev"),nextBtn:document.getElementById("search-next"),paragraphs:document.querySelectorAll(".library-book__paragraph")}}function b(){t.searchInput&&(t.searchInput.addEventListener("input",C(T,300)),t.searchInput.addEventListener("keydown",v),t.clearBtn?.addEventListener("click",w),t.prevBtn?.addEventListener("click",O),t.nextBtn?.addEventListener("click",I),document.addEventListener("keydown",s=>{s.key==="/"&&!s.target.matches("input, textarea")&&(s.preventDefault(),t.searchInput?.focus())}))}function T(s){const c=s.target.value.trim();if(a.searchQuery=c,t.clearBtn?.classList.toggle("hidden",!c),!c){w();return}if(M(c)){G(c);return}c.length>=S.minSearchLength&&N(c)}function v(s){switch(s.key){case"Enter":s.shiftKey?O():I(),s.preventDefault();break;case"Escape":w(),t.searchInput?.blur();break}}function M(s){return[/^\d+:\d+$/,/^\w+-\d+:\d+$/,/^\w+\s+\d+:\d+$/,/^chapter\s+\d+\s*(?:paragraph|para|p)?\s*\d+$/i,/^c\d+p\d+$/].some(p=>p.test(s))}function G(s){let c,p;const k=s.match(/^(\d+):(\d+)$/),m=s.match(/^(?:\w+-)?(\d+):(\d+)$/),i=s.match(/^(?:chapter\s+)?(\d+)\s*(?:paragraph|para|p)?\s*(\d+)$/i),n=s.match(/^c(\d+)p(\d+)$/);k?[,c,p]=k:m?[,c,p]=m:i?[,c,p]=i:n&&([,c,p]=n),c&&p&&B(parseInt(c),parseInt(p))}function B(s,c){const p=`c${s}p${c}`,k=document.getElementById(p);if(k){L(),k.scrollIntoView({behavior:"smooth",block:"center"}),k.classList.add("library-book__paragraph--selected");const m=window.location.pathname+"#"+p;history.replaceState(null,null,m),window.LibraryReader&&window.LibraryReader.selectParagraph(p),R(`Jumped to ${a.bookCode||""} ${s}:${c}`)}else R(`Reference ${s}:${c} not found`)}function N(s){L(),a.searchResults=[],a.currentResultIndex=-1;const c=s.toLowerCase();let p=0;t.paragraphs.forEach((k,m)=>{const i=k.querySelector(".library-book__para-translation"),n=k.querySelector(".library-book__para-original"),h=i?.textContent||"",e=n?.textContent||"",o=h.toLowerCase().includes(c),d=e.toLowerCase().includes(c);(o||d)&&(a.searchResults.push({element:k,index:p++}),o&&i&&P(i,s),d&&n&&n.style.display!=="none"&&P(n,s))}),E(),a.searchResults.length>0&&_(0)}function P(s,c){const p=document.createTreeWalker(s,NodeFilter.SHOW_TEXT,null,!1),k=[];for(;p.nextNode();)k.push(p.currentNode);const m=c.toLowerCase();k.forEach(i=>{const n=i.textContent,e=n.toLowerCase().indexOf(m);if(e!==-1){const o=n.substring(0,e),d=n.substring(e,e+c.length),r=n.substring(e+c.length),l=document.createElement("span");l.innerHTML=`${x(o)}<mark class="${S.highlightClass}">${x(d)}</mark>${x(r)}`,i.parentNode.replaceChild(l,i)}})}function L(){document.querySelectorAll(`.${S.highlightClass}`).forEach(s=>{const c=s.textContent;s.parentNode.replaceChild(document.createTextNode(c),s)}),t.paragraphs.forEach(s=>{s.querySelectorAll(".library-book__para-translation, .library-book__para-original").forEach(c=>{c.normalize()})}),document.querySelectorAll(".library-search__current-result").forEach(s=>{s.classList.remove("library-search__current-result")})}function E(){const s=a.searchResults.length>0;t.searchNav?.classList.toggle("hidden",!a.searchQuery||a.searchResults.length===0),t.searchCount&&(a.searchQuery&&a.searchResults.length===0?t.searchCount.textContent="No results":t.searchCount.textContent=`${a.currentResultIndex+1}/${a.searchResults.length}`)}function _(s){if(s<0||s>=a.searchResults.length)return;document.querySelectorAll(".library-search__current-result").forEach(p=>{p.classList.remove("library-search__current-result")}),a.currentResultIndex=s;const c=a.searchResults[s];c&&c.element&&(c.element.classList.add("library-search__current-result"),c.element.scrollIntoView({behavior:"smooth",block:"center"})),E()}function I(){if(a.searchResults.length===0)return;let s=a.currentResultIndex+1;s>=a.searchResults.length&&(s=0),_(s)}function O(){if(a.searchResults.length===0)return;let s=a.currentResultIndex-1;s<0&&(s=a.searchResults.length-1),_(s)}function w(){t.searchInput&&(t.searchInput.value=""),a.searchQuery="",a.searchResults=[],a.currentResultIndex=-1,L(),E(),t.clearBtn?.classList.add("hidden"),t.searchNav?.classList.add("hidden")}function H(){const s=window.location.hash.substring(1);if(s&&s.includes("-")&&s.includes(":")){const c=s.match(/^(\w+)-(\d+):(\d+)$/);if(c){const[,p,k,m]=c;setTimeout(()=>B(parseInt(k),parseInt(m)),500)}}}function x(s){const c=document.createElement("div");return c.textContent=s,c.innerHTML}function C(s,c){let p;return function(...k){clearTimeout(p),p=setTimeout(()=>s.apply(this,k),c)}}function R(s){window.LibraryReader&&window.LibraryReader.showToast&&window.LibraryReader.showToast(s)}return{init:$,search:N,goToReference:B,goToNextResult:I,goToPreviousResult:O,clearSearch:w,getResults:()=>[...a.searchResults]}}();document.addEventListener("DOMContentLoaded",()=>{V.init()});window.LibrarySearch=V;const F=function(){"use strict";const S={highlightColors:[{id:"yellow",name:"Yellow",color:"#fef08a"},{id:"green",name:"Green",color:"#bbf7d0"},{id:"blue",name:"Blue",color:"#bfdbfe"},{id:"pink",name:"Pink",color:"#fbcfe8"}]};let a={bookSlug:null,bookCode:null,isInitialized:!1,isPanelOpen:!1},t={};function $(i={}){if(a.isInitialized)return;const n=document.querySelector(".library-book");if(!n||!window.LibraryStorage){console.log("[LibraryStudyTools] Not on a book page or storage unavailable");return}a.bookSlug=i.bookSlug||n.dataset.bookSlug||A(),a.bookCode=i.bookCode||n.dataset.bookCode||"",q(),v(),M(),c(),a.isInitialized=!0,console.log("[LibraryStudyTools] Initialized for:",a.bookSlug)}function A(){const n=window.location.pathname.match(/\/library\/([^/]+)/);return n?n[1]:""}function q(){document.querySelectorAll(".library-book__paragraph").forEach(i=>{f(i)}),b(),T()}function f(i){const n=i.dataset.refId||i.id;if(i.querySelector(".study-tools__para-toolbar"))return;const e=document.createElement("div");e.className="study-tools__para-toolbar",e.innerHTML=`
            <button class="study-tools__btn study-tools__btn--bookmark"
                    data-action="bookmark"
                    data-ref="${n}"
                    title="Bookmark (b)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>
            <button class="study-tools__btn study-tools__btn--note"
                    data-action="note"
                    data-ref="${n}"
                    title="Add note">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </button>
        `,i.appendChild(e),window.LibraryStorage.isBookmarked(a.bookSlug,n)&&e.querySelector('[data-action="bookmark"]').classList.add("active"),window.LibraryStorage.getNote(a.bookSlug,n)&&e.querySelector('[data-action="note"]').classList.add("has-note")}function b(){const i=document.createElement("div");i.id="study-panel",i.className="study-panel hidden",i.innerHTML=`
            <div class="study-panel__header">
                <h3 class="study-panel__title">My Study Notes</h3>
                <button class="study-panel__close" aria-label="Close panel">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="study-panel__tabs" role="tablist">
                <button class="study-panel__tab study-panel__tab--active" data-tab="bookmarks" role="tab">
                    Bookmarks
                </button>
                <button class="study-panel__tab" data-tab="notes" role="tab">
                    Notes
                </button>
            </div>
            <div class="study-panel__content">
                <div class="study-panel__list" id="study-panel-bookmarks"></div>
                <div class="study-panel__list hidden" id="study-panel-notes"></div>
            </div>
            <div class="study-panel__footer">
                <button class="study-panel__export" data-action="export">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
                <button class="study-panel__import" data-action="import">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Import
                </button>
            </div>
        `,document.body.appendChild(i);const n=document.querySelector(".library-book__actions");if(n){const h=document.createElement("button");h.id="study-panel-toggle",h.className="library-book__btn library-book__btn--secondary",h.title="My Notes",h.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="desktop-only">Notes</span>
                <span class="study-panel__badge hidden" id="study-badge">0</span>
            `,n.appendChild(h)}}function T(){const i=document.createElement("div");i.id="highlight-picker",i.className="highlight-picker hidden",i.innerHTML=`
            <div class="highlight-picker__colors">
                ${S.highlightColors.map(n=>`
                    <button class="highlight-picker__color"
                            data-color="${n.id}"
                            style="background-color: ${n.color}"
                            title="${n.name}">
                    </button>
                `).join("")}
                <button class="highlight-picker__remove" data-action="remove-highlight" title="Remove">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        `,document.body.appendChild(i)}function v(){t={panel:document.getElementById("study-panel"),panelToggle:document.getElementById("study-panel-toggle"),bookmarksList:document.getElementById("study-panel-bookmarks"),notesList:document.getElementById("study-panel-notes"),badge:document.getElementById("study-badge"),highlightPicker:document.getElementById("highlight-picker"),paragraphs:document.querySelectorAll(".library-book__paragraph")}}function M(){t.panelToggle&&t.panelToggle.addEventListener("click",I);const i=t.panel?.querySelector(".study-panel__close");i&&i.addEventListener("click",w),t.panel?.querySelectorAll(".study-panel__tab").forEach(n=>{n.addEventListener("click",()=>H(n.dataset.tab))}),document.addEventListener("click",G),document.addEventListener("mouseup",P),t.highlightPicker?.addEventListener("click",L),t.panel?.querySelector('[data-action="export"]')?.addEventListener("click",p),t.panel?.querySelector('[data-action="import"]')?.addEventListener("click",k),document.addEventListener("click",n=>{!n.target.closest(".highlight-picker")&&!n.target.closest(".study-tools__btn--highlight")&&_()})}function G(i){const n=i.target.closest("[data-action]");if(!n)return;const h=n.dataset.action,e=n.dataset.ref;switch(h){case"bookmark":B(e,n);break;case"note":N(e,n);break}}function B(i,n){window.LibraryStorage.isBookmarked(a.bookSlug,i)?(window.LibraryStorage.removeBookmark(a.bookSlug,i),n.classList.remove("active"),m("Bookmark removed")):(window.LibraryStorage.addBookmark(a.bookSlug,i),n.classList.add("active"),m("Bookmark added")),s(),x()}function N(i,n){const h=window.LibraryStorage.getNote(a.bookSlug,i),e=n.closest(".library-book__paragraph");document.querySelectorAll(".study-tools__note-editor").forEach(l=>l.remove());const o=document.createElement("div");o.className="study-tools__note-editor",o.innerHTML=`
            <textarea class="study-tools__note-input" placeholder="Add your note...">${h?.content||""}</textarea>
            <div class="study-tools__note-actions">
                <button class="study-tools__note-save" data-action="save-note" data-ref="${i}">Save</button>
                <button class="study-tools__note-cancel" data-action="cancel-note">Cancel</button>
                ${h?'<button class="study-tools__note-delete" data-action="delete-note" data-ref="'+i+'">Delete</button>':""}
            </div>
        `,e.appendChild(o);const d=o.querySelector("textarea");d.focus(),o.querySelector('[data-action="save-note"]').addEventListener("click",()=>{const l=d.value.trim();l&&(window.LibraryStorage.addNote(a.bookSlug,i,l),n.classList.add("has-note"),m("Note saved")),o.remove(),s(),C()}),o.querySelector('[data-action="cancel-note"]').addEventListener("click",()=>{o.remove()});const r=o.querySelector('[data-action="delete-note"]');r&&r.addEventListener("click",()=>{window.LibraryStorage.removeNote(a.bookSlug,i),n.classList.remove("has-note"),m("Note deleted"),o.remove(),s(),C()})}function P(i){const n=window.getSelection(),h=n.toString().trim();if(!h||h.length<3){_();return}const e=i.target.closest(".library-book__paragraph");if(!e){_();return}const d=n.getRangeAt(0).getBoundingClientRect();t.highlightPicker.style.top=`${d.top+window.scrollY-40}px`,t.highlightPicker.style.left=`${d.left+d.width/2-60}px`,t.highlightPicker.classList.remove("hidden"),t.highlightPicker.dataset.refId=e.dataset.refId||e.id,t.highlightPicker.dataset.text=h}function L(i){const n=i.target.closest("[data-color]"),h=i.target.closest('[data-action="remove-highlight"]');if(n){const e=n.dataset.color,o=t.highlightPicker.dataset.refId,d=t.highlightPicker.dataset.text;window.LibraryStorage.addHighlight(a.bookSlug,o,e,d),E(o,d,e),m("Text highlighted"),_()}else h&&_()}function E(i,n,h){const e=document.querySelector(`[data-ref-id="${i}"], #${i}`);if(!e)return;const o=S.highlightColors.find(r=>r.id===h)?.color||"#fef08a",d=e.querySelector(".library-book__para-translation");if(d){const r=d.innerHTML,l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=new RegExp(`(${l})`,"gi");d.innerHTML=r.replace(u,`<mark class="study-highlight" style="background-color: ${o}">$1</mark>`)}}function _(){t.highlightPicker&&t.highlightPicker.classList.add("hidden")}function I(){a.isPanelOpen?w():O()}function O(){t.panel&&(t.panel.classList.remove("hidden"),a.isPanelOpen=!0,x(),C())}function w(){t.panel&&(t.panel.classList.add("hidden"),a.isPanelOpen=!1)}function H(i){t.panel?.querySelectorAll(".study-panel__tab").forEach(n=>{n.classList.toggle("study-panel__tab--active",n.dataset.tab===i)}),t.bookmarksList&&t.bookmarksList.classList.toggle("hidden",i!=="bookmarks"),t.notesList&&t.notesList.classList.toggle("hidden",i!=="notes")}function x(){if(!t.bookmarksList)return;const i=window.LibraryStorage.getBookmarks(a.bookSlug);if(i.length===0){t.bookmarksList.innerHTML=`
                <div class="study-panel__empty">
                    <p>No bookmarks yet</p>
                    <p class="study-panel__hint">Click the bookmark icon on any paragraph to save it.</p>
                </div>
            `;return}t.bookmarksList.innerHTML=i.map(n=>{const e=document.querySelector(`[data-ref-id="${n.refId}"], #${n.refId.replace(/:/g,"\\:")}`)?.querySelector(".library-book__para-translation")?.textContent.substring(0,100)||"";return`
                <div class="study-panel__item" data-ref="${n.refId}">
                    <div class="study-panel__item-ref">${n.refId}</div>
                    <div class="study-panel__item-preview">${e}...</div>
                    ${n.note?`<div class="study-panel__item-note">${n.note}</div>`:""}
                    <div class="study-panel__item-actions">
                        <button class="study-panel__item-goto" data-action="goto" data-ref="${n.refId}">Go to</button>
                        <button class="study-panel__item-remove" data-action="remove-bookmark" data-ref="${n.refId}">Remove</button>
                    </div>
                </div>
            `}).join(""),t.bookmarksList.querySelectorAll('[data-action="goto"]').forEach(n=>{n.addEventListener("click",()=>R(n.dataset.ref))}),t.bookmarksList.querySelectorAll('[data-action="remove-bookmark"]').forEach(n=>{n.addEventListener("click",()=>{const h=n.dataset.ref;window.LibraryStorage.removeBookmark(a.bookSlug,h);const e=document.querySelector(`[data-ref="${h}"][data-action="bookmark"]`);e&&e.classList.remove("active"),x(),s(),m("Bookmark removed")})})}function C(){if(!t.notesList)return;const i=window.LibraryStorage.getNotes(a.bookSlug);if(i.length===0){t.notesList.innerHTML=`
                <div class="study-panel__empty">
                    <p>No notes yet</p>
                    <p class="study-panel__hint">Click the note icon on any paragraph to add a note.</p>
                </div>
            `;return}t.notesList.innerHTML=i.map(n=>`
            <div class="study-panel__item" data-ref="${n.refId}">
                <div class="study-panel__item-ref">${n.refId}</div>
                <div class="study-panel__item-note">${n.content}</div>
                <div class="study-panel__item-date">${new Date(n.updatedAt).toLocaleDateString()}</div>
                <div class="study-panel__item-actions">
                    <button class="study-panel__item-goto" data-action="goto" data-ref="${n.refId}">Go to</button>
                    <button class="study-panel__item-edit" data-action="edit-note" data-ref="${n.refId}">Edit</button>
                    <button class="study-panel__item-remove" data-action="remove-note" data-ref="${n.refId}">Remove</button>
                </div>
            </div>
        `).join(""),t.notesList.querySelectorAll('[data-action="goto"]').forEach(n=>{n.addEventListener("click",()=>R(n.dataset.ref))}),t.notesList.querySelectorAll('[data-action="remove-note"]').forEach(n=>{n.addEventListener("click",()=>{const h=n.dataset.ref;window.LibraryStorage.removeNote(a.bookSlug,h);const e=document.querySelector(`[data-ref="${h}"][data-action="note"]`);e&&e.classList.remove("has-note"),C(),s(),m("Note removed")})})}function R(i){let n=document.querySelector(`[data-ref-id="${i}"]`);if(!n){const h=i.match(/^\w+-(\d+):(\d+)$/);h&&(n=document.getElementById(`c${h[1]}p${h[2]}`))}n&&(w(),n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("library-book__paragraph--selected"),setTimeout(()=>n.classList.remove("library-book__paragraph--selected"),2e3))}function s(){if(!t.badge)return;const i=window.LibraryStorage.getBookmarks(a.bookSlug),n=window.LibraryStorage.getNotes(a.bookSlug),h=i.length+n.length;h>0?(t.badge.textContent=h,t.badge.classList.remove("hidden")):t.badge.classList.add("hidden")}function c(){window.LibraryStorage.getBookmarks(a.bookSlug).forEach(e=>{const o=document.querySelector(`[data-ref="${e.refId}"][data-action="bookmark"]`);o&&o.classList.add("active")}),window.LibraryStorage.getNotes(a.bookSlug).forEach(e=>{const o=document.querySelector(`[data-ref="${e.refId}"][data-action="note"]`);o&&o.classList.add("has-note")}),window.LibraryStorage.getHighlights(a.bookSlug).forEach(e=>{E(e.refId,e.text,e.color)}),s()}function p(){const i=window.LibraryStorage.exportData(),n=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),h=URL.createObjectURL(n),e=document.createElement("a");e.href=h,e.download=`woh-study-notes-${new Date().toISOString().split("T")[0]}.json`,e.click(),URL.revokeObjectURL(h),m("Study data exported")}function k(){const i=document.createElement("input");i.type="file",i.accept=".json",i.addEventListener("change",n=>{const h=n.target.files[0];if(!h)return;const e=new FileReader;e.onload=o=>{try{const d=JSON.parse(o.target.result);window.LibraryStorage.importData(d)?(m("Study data imported"),c(),x(),C()):m("Import failed - invalid data")}catch{m("Import failed - invalid file")}},e.readAsText(h)}),i.click()}function m(i){window.LibraryReader&&window.LibraryReader.showToast?window.LibraryReader.showToast(i):console.log("[StudyTools]",i)}return{init:$,togglePanel:I,openPanel:O,closePanel:w,toggleBookmark:B,goToRef:R,exportStudyData:p,importStudyData:k}}();document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>F.init(),100)});window.LibraryStudyTools=F;})();
