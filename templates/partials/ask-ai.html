<!-- Ask AI Panel - Dropdown panel for discussing page content with AI -->
<div class="ask-ai-panel" id="askAiPanel" aria-hidden="true">
    <div class="ask-ai-panel__container">
        <div class="ask-ai-panel__header">
            <h3 class="ask-ai-panel__title">Discuss with AI</h3>
            <p class="ask-ai-panel__subtitle">Copy the prompt and open your preferred AI</p>
        </div>

        <div class="ask-ai-panel__services">
            <button class="ask-ai-panel__service" data-service="claude">
                <span class="ask-ai-panel__service-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.709 15.955l4.72-2.647.08-.08 2.726-4.721c.16-.16.4-.24.64-.24.24 0 .48.08.64.24l2.726 4.72.08.08 4.72 2.648c.16.16.24.4.24.64s-.08.48-.24.64l-4.72 2.726-.08.08-2.726 4.72c-.16.16-.4.24-.64.24-.24 0-.48-.08-.64-.24l-2.726-4.72-.08-.08-4.72-2.726c-.16-.16-.24-.4-.24-.64s.08-.48.24-.64z"/>
                    </svg>
                </span>
                <span class="ask-ai-panel__service-name">Claude</span>
            </button>
            <button class="ask-ai-panel__service" data-service="chatgpt">
                <span class="ask-ai-panel__service-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/>
                    </svg>
                </span>
                <span class="ask-ai-panel__service-name">ChatGPT</span>
            </button>
            <button class="ask-ai-panel__service" data-service="perplexity">
                <span class="ask-ai-panel__service-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </span>
                <span class="ask-ai-panel__service-name">Perplexity</span>
            </button>
            <button class="ask-ai-panel__service" data-service="gemini">
                <span class="ask-ai-panel__service-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </span>
                <span class="ask-ai-panel__service-name">Gemini</span>
            </button>
        </div>

        <div class="ask-ai-panel__status" id="askAiStatus" aria-live="polite"></div>

        <div class="ask-ai-panel__footer" id="askAiFooter">
            <p class="ask-ai-panel__hint">Prompt copied to clipboard. Paste it in the AI chat.</p>
        </div>
    </div>
</div>

<script>
(function() {
    const panel = document.getElementById('askAiPanel');
    const status = document.getElementById('askAiStatus');
    const footer = document.getElementById('askAiFooter');
    const triggers = document.querySelectorAll('.navbar__ask-ai-trigger');
    const services = document.querySelectorAll('.ask-ai-panel__service');

    // AI service URLs (perplexity supports query params)
    const serviceUrls = {
        claude: 'https://claude.ai/new',
        chatgpt: 'https://chat.openai.com/',
        perplexity: 'https://www.perplexity.ai/search',
        gemini: 'https://gemini.google.com/app'
    };

    // Services that support URL query parameters
    const supportsUrlQuery = ['perplexity'];

    // Build the prompt with page context
    function buildPrompt() {
        const title = document.title || 'Untitled Page';
        const url = window.location.href;
        const description = document.querySelector('meta[name="description"]')?.content || '';
        const summary = document.querySelector('[data-ai-summary]')?.textContent?.trim() || '';

        // Get main content text (first 1500 chars)
        const mainContent = document.querySelector('.wiki__content, .explainer__content, .essentials__content, .resources__content, article')?.textContent?.trim() || '';
        const contentPreview = mainContent.substring(0, 1500).replace(/\s+/g, ' ');

        const prompt = `I'm reading a page from Wheel of Heaven (wheelofheaven.io), a knowledge base exploring the hypothesis that life on Earth was intelligently designed by an extraterrestrial civilization called the Elohim, as described in ancient texts.

**Page:** ${title}
**URL:** ${url}
${description ? `**Description:** ${description}` : ''}
${summary ? `**Summary:** ${summary}` : ''}

**Content Preview:**
${contentPreview}${mainContent.length > 1500 ? '...' : ''}

---

Please help me understand this content. You can:
- Explain key concepts mentioned on this page
- Answer questions I have about the Elohim hypothesis
- Provide historical or scientific context
- Discuss connections to other ancient texts or traditions
- Offer critical analysis or alternative perspectives

What would you like to know about this page?`;

        return prompt;
    }

    // Copy prompt to clipboard
    async function copyPrompt() {
        const prompt = buildPrompt();
        try {
            await navigator.clipboard.writeText(prompt);
            return true;
        } catch (err) {
            const textarea = document.createElement('textarea');
            textarea.value = prompt;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                document.body.removeChild(textarea);
                return true;
            } catch (e) {
                document.body.removeChild(textarea);
                return false;
            }
        }
    }

    // Position panel below navbar, aligned to trigger
    function positionPanel(trigger) {
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            const navbarRect = navbar.getBoundingClientRect();
            panel.style.top = `${navbarRect.bottom + 1}px`;

            // Position horizontally - try to align with trigger
            if (trigger) {
                const triggerRect = trigger.getBoundingClientRect();
                const panelWidth = 320;
                const viewportWidth = window.innerWidth;

                // Calculate ideal right position to align with trigger
                let rightPos = viewportWidth - triggerRect.right;

                // Make sure panel doesn't go off left edge
                if (viewportWidth - rightPos - panelWidth < 0) {
                    rightPos = viewportWidth - panelWidth - 16;
                }

                panel.style.right = `${rightPos}px`;
                panel.style.left = 'auto';
            }
        }
    }

    // Toggle panel
    let activeTrigger = null;
    function togglePanel(open, trigger) {
        const isOpen = open !== undefined ? open : !panel.classList.contains('ask-ai-panel--open');

        if (isOpen) {
            activeTrigger = trigger;
            positionPanel(trigger);
            status.textContent = '';
            footer.style.display = 'none';
        }

        panel.classList.toggle('ask-ai-panel--open', isOpen);
        panel.setAttribute('aria-hidden', !isOpen);
        triggers.forEach(t => t.setAttribute('aria-expanded', isOpen));
    }

    // Handle service click
    async function handleServiceClick(service) {
        const prompt = buildPrompt();

        // Perplexity supports URL query params - open directly with prompt
        if (supportsUrlQuery.includes(service)) {
            const url = `${serviceUrls[service]}?q=${encodeURIComponent(prompt)}`;
            status.textContent = 'Opening with prompt...';
            status.className = 'ask-ai-panel__status ask-ai-panel__status--success';
            setTimeout(() => {
                window.open(url, '_blank', 'noopener,noreferrer');
            }, 200);
            return;
        }

        // For other services, copy to clipboard first
        const copied = await copyPrompt();

        if (copied) {
            status.textContent = 'Prompt copied!';
            status.className = 'ask-ai-panel__status ask-ai-panel__status--success';
            footer.style.display = 'block';

            setTimeout(() => {
                window.open(serviceUrls[service], '_blank', 'noopener,noreferrer');
            }, 300);
        } else {
            status.textContent = 'Failed to copy. Please try again.';
            status.className = 'ask-ai-panel__status ask-ai-panel__status--error';
        }
    }

    // Event listeners
    triggers.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePanel(undefined, trigger);
        });
    });

    services.forEach(btn => {
        btn.addEventListener('click', () => {
            handleServiceClick(btn.dataset.service);
        });
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && !e.target.closest('.navbar__ask-ai-trigger') && panel.classList.contains('ask-ai-panel--open')) {
            togglePanel(false);
        }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel.classList.contains('ask-ai-panel--open')) {
            togglePanel(false);
        }
    });

    // Reposition on scroll/resize
    window.addEventListener('scroll', () => {
        if (panel.classList.contains('ask-ai-panel--open')) {
            positionPanel(activeTrigger);
        }
    }, { passive: true });

    window.addEventListener('resize', () => {
        if (panel.classList.contains('ask-ai-panel--open')) {
            positionPanel(activeTrigger);
        }
    });
})();
</script>
