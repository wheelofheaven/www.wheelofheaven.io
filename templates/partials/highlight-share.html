<!-- Highlight & Share - Shows popup when text is selected -->
<div class="highlight-share" id="highlightShare" role="tooltip" aria-hidden="true">
    <div class="highlight-share__content">
        <button class="highlight-share__btn" data-action="copy" aria-label="{{ trans(key='highlightCopy', default='Copy quote') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <svg class="highlight-share__icon-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </button>
        <button class="highlight-share__btn" data-action="twitter" aria-label="{{ trans(key='highlightShareX', default='Share on X') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
        </button>
        <button class="highlight-share__btn" data-action="reddit" aria-label="{{ trans(key='highlightShareReddit', default='Share on Reddit') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
            </svg>
        </button>
    </div>
    <div class="highlight-share__arrow"></div>
</div>

<script>
(function() {
    const popup = document.getElementById('highlightShare');
    if (!popup) return;

    // Content areas where highlight-share is enabled
    const contentSelectors = '.wiki__content, .explainer__content, .essentials__content, .resources__content, .library__content, .info-page__content, article';
    const contentAreas = document.querySelectorAll(contentSelectors);

    if (contentAreas.length === 0) return;

    let selectedText = '';
    let isVisible = false;

    // Get page info for attribution
    const pageTitle = document.title.split(' | ')[0] || document.title;
    const pageUrl = window.location.href;

    function showPopup(x, y) {
        const popupWidth = 120;
        const popupHeight = 44;
        const padding = 10;

        // Position above the selection
        let left = x - popupWidth / 2;
        let top = y - popupHeight - padding;

        // Keep within viewport horizontally
        if (left < padding) left = padding;
        if (left + popupWidth > window.innerWidth - padding) {
            left = window.innerWidth - popupWidth - padding;
        }

        // If too close to top, show below
        if (top < padding) {
            top = y + padding;
            popup.classList.add('highlight-share--below');
        } else {
            popup.classList.remove('highlight-share--below');
        }

        popup.style.left = `${left}px`;
        popup.style.top = `${top + window.scrollY}px`;
        popup.classList.add('highlight-share--visible');
        popup.setAttribute('aria-hidden', 'false');
        isVisible = true;
    }

    function hidePopup() {
        popup.classList.remove('highlight-share--visible');
        popup.setAttribute('aria-hidden', 'true');
        popup.classList.remove('highlight-share--copied');
        isVisible = false;
    }

    function getSelectedText() {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return '';

        const text = selection.toString().trim();
        if (!text || text.length < 5) return ''; // Minimum 5 chars

        // Check if selection is within our content areas
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        const element = container.nodeType === 3 ? container.parentElement : container;

        let isInContent = false;
        contentAreas.forEach(area => {
            if (area.contains(element)) isInContent = true;
        });

        return isInContent ? text : '';
    }

    function formatQuote(text) {
        // Truncate if too long
        let quote = text;
        if (quote.length > 280) {
            quote = quote.substring(0, 277) + '...';
        }
        return `"${quote}"\n\n— ${pageTitle}\n${pageUrl}`;
    }

    // Handle text selection
    document.addEventListener('mouseup', (e) => {
        // Ignore if clicking on the popup itself
        if (popup.contains(e.target)) return;

        // Small delay to let selection complete
        setTimeout(() => {
            selectedText = getSelectedText();

            if (selectedText) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();

                // Position at the center-top of selection
                const x = rect.left + rect.width / 2;
                const y = rect.top;

                showPopup(x, y);
            } else {
                hidePopup();
            }
        }, 10);
    });

    // Hide on click outside or new selection start
    document.addEventListener('mousedown', (e) => {
        if (!popup.contains(e.target) && isVisible) {
            hidePopup();
        }
    });

    // Hide on scroll
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        if (isVisible) {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(hidePopup, 100);
        }
    }, { passive: true });

    // Hide on escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isVisible) {
            hidePopup();
            window.getSelection()?.removeAllRanges();
        }
    });

    // Handle button clicks
    popup.addEventListener('click', async (e) => {
        const btn = e.target.closest('.highlight-share__btn');
        if (!btn) return;

        const action = btn.dataset.action;
        const quote = formatQuote(selectedText);
        const shortQuote = selectedText.length > 200
            ? selectedText.substring(0, 197) + '...'
            : selectedText;

        switch (action) {
            case 'copy':
                try {
                    await navigator.clipboard.writeText(quote);
                    popup.classList.add('highlight-share--copied');
                    setTimeout(() => {
                        popup.classList.remove('highlight-share--copied');
                    }, 1500);
                } catch (err) {
                    // Fallback
                    const textarea = document.createElement('textarea');
                    textarea.value = quote;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    popup.classList.add('highlight-share--copied');
                    setTimeout(() => {
                        popup.classList.remove('highlight-share--copied');
                    }, 1500);
                }
                break;

            case 'twitter':
                const tweetText = `"${shortQuote}"\n\n— ${pageTitle}`;
                window.open(
                    `https://x.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(pageUrl)}`,
                    '_blank',
                    'width=550,height=420'
                );
                hidePopup();
                break;

            case 'reddit':
                const redditTitle = `"${shortQuote}" — ${pageTitle}`;
                window.open(
                    `https://www.reddit.com/submit?url=${encodeURIComponent(pageUrl)}&title=${encodeURIComponent(redditTitle)}`,
                    '_blank',
                    'width=550,height=420'
                );
                hidePopup();
                break;
        }
    });
})();
</script>
