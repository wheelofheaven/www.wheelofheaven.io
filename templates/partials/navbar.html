<nav class="navbar" aria-label="Main navigation">
  <!-- Desktop navbar -->
  <a class="navbar__logo" href="/" aria-label="Wheel of Heaven">
    {% include "partials/brand/logomark.html" %}
  </a>

  <div class="navbar__content">
    <div class="navbar__links">
      <a href="/essentials" class="navbar__link">Essentials</a>
      <a href="/explainers" class="navbar__link">Explainers</a>
      <a href="/timeline" class="navbar__link">Timeline</a>
      <a href="{{ get_url(path="revelations", lang=lang) }}" class="navbar__link">Revelations</a>
      <a href="/wiki" class="navbar__link">Wiki</a>
    </div>

    <!-- Mobile controls section -->
    <div class="navbar__mobile-content">
      <div class="navbar__mobile-controls">
        <button id="mobile-theme-toggle" class="navbar__theme-toggle" aria-label="Toggle dark/light mode">
          <span class="navbar__theme-icon">
              <span class="icon icon--moon">{% include "partials/icons/feather-moon.html" %}</span>
              <span class="icon icon--sun">{% include "partials/icons/feather-sun.html" %}</span>
          </span>
        </button>

        <div class="navbar__language-switcher" id="mobile-lang-switcher">
          <Icon name="lucide:globe" size="16" />
          <select id="mobile-lang-select" class="navbar__select" aria-label="Select language">
            <!-- Default language (English) -->
            <option value="{{ config.default_language }}" {% if config.default_language == lang %}selected{% endif %}>
              English
            </option>
            <!-- Sorted alphabetically by language code -->
            {% set_global sorted_langs = [] %}
            {% for lang_code, lang_config in config.languages %}
              {% if lang_code != config.default_language %}
                {% set_global sorted_langs = sorted_langs | concat(with=lang_code) %}
              {% endif %}
            {% endfor %}
            {% for lang_code in ["de", "es", "fr", "ja", "ru", "zh"] %}
              {% if lang_code in sorted_langs %}
                <option value="{{ lang_code }}" {% if lang_code == lang %}selected{% endif %}>
                  {% if lang_code == "de" %}Deutsch
                  {% elif lang_code == "es" %}Español
                  {% elif lang_code == "fr" %}Français
                  {% elif lang_code == "ja" %}日本語
                  {% elif lang_code == "ru" %}Русский
                  {% elif lang_code == "zh" %}中文
                  {% else %}{{ lang_code | upper }}
                  {% endif %}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="navbar__controls">
    <div class="navbar__mobile-search mobile-only">
      <input
          type="search"
          class="navbar__mobile-search-input"
          placeholder="Search..."
          aria-label="Search site"
          id="mobileSearchInput"
      />
    </div>

    <button class="navbar__mobile-toggle mobile-only" id="mobileSearchToggle" aria-label="Toggle search">
      {% include "partials/icons/feather-search.html" %}
    </button>

    <button class="navbar__mobile-toggle mobile-only" id="mobileNavToggle" aria-label="Toggle mobile navigation">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <div class="navbar__search desktop-only">
      <input
          type="search"
          class="navbar__search-input"
          placeholder="Search..."
          aria-label="Search site"
      />
    </div>

    <div class="navbar__language-switcher" id="lang-switcher">
      <Icon name="lucide:globe" size="16" />
      <select id="lang-select" class="navbar__select" aria-label="Select language">
        <!-- Default language (English) -->
        <option value="{{ config.default_language }}" {% if config.default_language == lang %}selected{% endif %}>
          English
        </option>
        <!-- Sorted alphabetically by language code -->
        {% for lang_code in ["de", "es", "fr", "ja", "ru", "zh"] %}
          {% if config.languages[lang_code] %}
            <option value="{{ lang_code }}" {% if lang_code == lang %}selected{% endif %}>
              {% if lang_code == "de" %}Deutsch
              {% elif lang_code == "es" %}Español
              {% elif lang_code == "fr" %}Français
              {% elif lang_code == "ja" %}日本語
              {% elif lang_code == "ru" %}Русский
              {% elif lang_code == "zh" %}中文
              {% else %}{{ lang_code | upper }}
              {% endif %}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <button id="theme-toggle" class="navbar__theme-toggle" aria-label="Toggle dark/light mode">
      <span class="navbar__theme-icon">
          <span class="icon icon--moon">{% include "partials/icons/feather-moon.html" %}</span>
          <span class="icon icon--sun">{% include "partials/icons/feather-sun.html" %}</span>
      </span>
    </button>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        function switchLanguage(targetLang) {
          const currentPath = window.location.pathname;
          const currentLang = '{{ lang }}';
          const defaultLang = '{{ config.default_language }}';
          const baseUrl = '{{ config.base_url | safe }}';

          // Remove trailing slash from base URL for consistent handling
          const cleanBaseUrl = baseUrl.replace(/\/$/, '');

          let newPath = currentPath;

          // If we're currently on a non-default language, remove the language prefix
          if (currentLang !== defaultLang) {
            // Remove /lang/ prefix or just /lang if at root
            const langPrefix = '/' + currentLang;
            if (newPath.startsWith(langPrefix + '/')) {
              newPath = newPath.substring(langPrefix.length);
            } else if (newPath === langPrefix) {
              newPath = '/';
            }
          }

          // Add the target language prefix if it's not the default language
          if (targetLang !== defaultLang) {
            newPath = '/' + targetLang + newPath;
          }

          // Ensure path starts with /
          if (!newPath.startsWith('/')) {
            newPath = '/' + newPath;
          }

          // Navigate to the new URL
          const newUrl = cleanBaseUrl + newPath;
          window.location.href = newUrl;
        }

        // Handle desktop language switcher
        const langSelect = document.getElementById('lang-select');
        if (langSelect) {
          langSelect.addEventListener('change', function(e) {
            const targetLang = e.target.value;
            if (targetLang !== '{{ lang }}') {
              switchLanguage(targetLang);
            }
          });
        }

        // Handle mobile language switcher
        const mobileLangSelect = document.getElementById('mobile-lang-select');
        if (mobileLangSelect) {
          mobileLangSelect.addEventListener('change', function(e) {
            const targetLang = e.target.value;
            if (targetLang !== '{{ lang }}') {
              switchLanguage(targetLang);
            }
          });
        }
      });
    </script>
  </div>

</nav>
