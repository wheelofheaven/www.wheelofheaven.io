<!-- Listen Button - Trigger -->
<button
    class="listen-trigger"
    id="listenTrigger"
    aria-label="Listen to this page"
    title="Listen to this page"
>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    <span>Listen</span>
</button>

<!-- Audio Player Bar - Fixed at bottom (SoundCloud style) -->
<div class="audio-player" id="audioPlayer" aria-hidden="true">
    <div class="audio-player__container">
        <!-- Play/Pause -->
        <button class="audio-player__play" id="audioPlayPause" aria-label="Play">
            <span class="audio-player__icon audio-player__icon--play">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </span>
            <span class="audio-player__icon audio-player__icon--pause">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            </span>
        </button>

        <!-- Time & Progress -->
        <span class="audio-player__time audio-player__time--current" id="audioTimeCurrent">0:00</span>

        <div class="audio-player__progress" id="audioProgress">
            <div class="audio-player__progress-bg"></div>
            <div class="audio-player__progress-fill" id="audioProgressFill"></div>
            <div class="audio-player__progress-handle" id="audioProgressHandle"></div>
        </div>

        <span class="audio-player__time audio-player__time--total" id="audioTimeTotal">0:00</span>

        <!-- Title -->
        <div class="audio-player__title" id="audioTitle">
            <span class="audio-player__title-text"></span>
        </div>

        <!-- Close -->
        <button class="audio-player__close" id="audioClose" aria-label="Stop and close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
</div>

<script>
(function() {
    if (!('speechSynthesis' in window)) {
        const btn = document.getElementById('listenTrigger');
        if (btn) btn.style.display = 'none';
        return;
    }

    const trigger = document.getElementById('listenTrigger');
    const player = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('audioPlayPause');
    const closeBtn = document.getElementById('audioClose');
    const progressBar = document.getElementById('audioProgress');
    const progressFill = document.getElementById('audioProgressFill');
    const progressHandle = document.getElementById('audioProgressHandle');
    const timeCurrent = document.getElementById('audioTimeCurrent');
    const timeTotal = document.getElementById('audioTimeTotal');
    const titleEl = document.querySelector('.audio-player__title-text');

    let utterance = null;
    let isPlaying = false;
    let isPaused = false;
    let textLength = 0;
    let estimatedDuration = 0;
    let startTime = 0;
    let pausedAt = 0;
    let progressInterval = null;

    function getContentText() {
        const selectors = [
            '.wiki__content',
            '.explainer__content',
            '.essentials__content',
            '.resources__content',
            '.library__content',
            'article .content',
            'article'
        ];

        for (const selector of selectors) {
            const el = document.querySelector(selector);
            if (el) {
                const clone = el.cloneNode(true);
                clone.querySelectorAll('script, style, nav, .toc, .breadcrumbs, .listen-trigger, .audio-player, sup, .wiki-cite').forEach(el => el.remove());
                let text = clone.textContent || clone.innerText;
                text = text.replace(/\s+/g, ' ').trim();
                return text;
            }
        }
        return '';
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgress(elapsed) {
        const percent = Math.min((elapsed / estimatedDuration) * 100, 100);
        progressFill.style.width = `${percent}%`;
        progressHandle.style.left = `${percent}%`;
        timeCurrent.textContent = formatTime(elapsed);
    }

    function startProgressTimer() {
        startTime = Date.now() - (pausedAt * 1000);
        progressInterval = setInterval(() => {
            if (isPlaying && !isPaused) {
                const elapsed = (Date.now() - startTime) / 1000;
                updateProgress(elapsed);
            }
        }, 100);
    }

    function stopProgressTimer() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    function showPlayer() {
        player.classList.add('audio-player--visible');
        player.setAttribute('aria-hidden', 'false');
        document.body.classList.add('has-audio-player');
    }

    function hidePlayer() {
        player.classList.remove('audio-player--visible');
        player.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('has-audio-player');
    }

    function updatePlayState(playing) {
        if (playing) {
            player.classList.add('audio-player--playing');
            player.classList.remove('audio-player--paused');
            playPauseBtn.setAttribute('aria-label', 'Pause');
        } else {
            player.classList.remove('audio-player--playing');
            player.classList.add('audio-player--paused');
            playPauseBtn.setAttribute('aria-label', 'Play');
        }
    }

    function speak() {
        const text = getContentText();
        if (!text) return;

        window.speechSynthesis.cancel();

        textLength = text.length;
        const wordCount = text.split(/\s+/).length;
        estimatedDuration = (wordCount / 150) * 60;
        pausedAt = 0;

        // Set title
        const pageTitle = document.title.split('|')[0].trim() || 'This page';
        titleEl.textContent = pageTitle;
        timeTotal.textContent = formatTime(estimatedDuration);

        utterance = new SpeechSynthesisUtterance(text);

        const voices = window.speechSynthesis.getVoices();
        const preferredVoices = voices.filter(v =>
            v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Samantha'))
        );
        if (preferredVoices.length > 0) {
            utterance.voice = preferredVoices[0];
        }

        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        utterance.onstart = () => {
            isPlaying = true;
            isPaused = false;
            updatePlayState(true);
            startProgressTimer();
        };

        utterance.onpause = () => {
            isPaused = true;
            pausedAt = (Date.now() - startTime) / 1000;
            stopProgressTimer();
            updatePlayState(false);
        };

        utterance.onresume = () => {
            isPaused = false;
            updatePlayState(true);
            startProgressTimer();
        };

        utterance.onend = () => {
            isPlaying = false;
            isPaused = false;
            stopProgressTimer();
            updateProgress(estimatedDuration);
            updatePlayState(false);
        };

        utterance.onerror = (e) => {
            if (e.error !== 'canceled') {
                console.error('Speech synthesis error:', e);
            }
            isPlaying = false;
            isPaused = false;
            stopProgressTimer();
            updatePlayState(false);
        };

        showPlayer();
        window.speechSynthesis.speak(utterance);
    }

    function togglePlayPause() {
        if (!isPlaying && !isPaused) {
            speak();
        } else if (isPlaying && !isPaused) {
            window.speechSynthesis.pause();
        } else if (isPaused) {
            window.speechSynthesis.resume();
        }
    }

    function stop() {
        window.speechSynthesis.cancel();
        isPlaying = false;
        isPaused = false;
        pausedAt = 0;
        stopProgressTimer();
        hidePlayer();
        progressFill.style.width = '0%';
        progressHandle.style.left = '0%';
        timeCurrent.textContent = '0:00';
    }

    // Event listeners
    trigger.addEventListener('click', () => {
        if (!isPlaying && !isPaused) {
            speak();
        } else {
            showPlayer();
        }
    });

    playPauseBtn.addEventListener('click', togglePlayPause);
    closeBtn.addEventListener('click', stop);

    // Load voices
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => {};
    }

    window.addEventListener('beforeunload', stop);
})();
</script>
