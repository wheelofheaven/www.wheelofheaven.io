{% extends "base.html" %} {% import "macros/wiki.html" as wiki_macros %} {%
block content %}
<div class="wiki-section">
    <div class="wiki-section__container">
        <!-- Minimal Header with Search -->
        <header class="wiki-header">
            <div class="wiki-header__left">
                <h1 class="wiki-header__title">{{ section.title }}</h1>
                {% if section.pages %}
                <span class="wiki-header__count">{{ section.pages | length }} articles</span>
                {% endif %}
            </div>
            <div class="wiki-header__search">
                <svg class="wiki-header__search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       class="wiki-header__search-input"
                       placeholder="Search articles..."
                       id="wiki-search"
                       autocomplete="off">
            </div>
        </header>

        {% if section.pages %}
        <!-- Quick Filters Bar -->
        <div class="wiki-filters">
            <div class="wiki-filters__left">
                <!-- Category Filter -->
                {% set all_categories = section.pages | map(attribute="extra.category") | unique | sort %}
                {% if all_categories %}
                <select class="wiki-filters__select" id="wiki-category-filter">
                    <option value="">All Topics</option>
                    {% for category in all_categories %}
                    {% if category %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                {% endif %}

                <!-- Sort Options -->
                <select class="wiki-filters__select" id="wiki-sort">
                    <option value="title">A-Z</option>
                    <option value="date">Recent</option>
                    <option value="category">Topic</option>
                </select>
            </div>

            <div class="wiki-filters__right">
                <!-- Random Article -->
                <button class="wiki-filters__random" id="random-article-btn" title="Random article">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 3h5v5"></path>
                        <path d="M4 20L21 3"></path>
                        <path d="M21 16v5h-5"></path>
                        <path d="M15 15l6 6"></path>
                        <path d="M4 4l5 5"></path>
                    </svg>
                    <span class="wiki-filters__random-text">Random</span>
                </button>

                <!-- View Toggle -->
                <div class="wiki-view-toggle">
                    <button class="wiki-view-toggle__btn wiki-view-toggle__btn--active" data-view="grid" title="Grid view">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="wiki-view-toggle__btn" data-view="list" title="List view">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alphabetical Quick Navigation -->
        <div class="wiki-alphabet">
            {% set alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ" | split(pat="") %}
            {% set first_letters = [] %}
            {% for page in section.pages %}
                {% set first_letter = page.title | truncate(length=1, end="") | upper %}
                {% set_global first_letters = first_letters | concat(with=first_letter) %}
            {% endfor %}
            {% set first_letters = first_letters | unique | sort %}
            {% for letter in alphabet %}
            {% if letter in first_letters %}
            <a href="#letter-{{ letter }}" class="wiki-alphabet__link wiki-alphabet__link--active">{{ letter }}</a>
            {% else %}
            <span class="wiki-alphabet__link wiki-alphabet__link--inactive">{{ letter }}</span>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Main Articles Grid/List -->
        <div class="wiki-section__pages">
            <div class="wiki-section__grid" id="wiki-articles" data-view="grid">
                {% for page in section.pages %}
                <article class="wiki-card"
                         data-title="{{ page.title | lower }}"
                         data-category="{{ page.extra.category | default(value="") | lower }}"
                         data-date="{{ page.date | default(value="") }}"
                         data-letter="{{ page.title | truncate(length=1, end="") | upper }}">

                    <!-- Letter anchor for alphabetical navigation -->
                    {% set current_letter = page.title | truncate(length=1, end="") | upper %}
                    {% if loop.first %}
                    <div id="letter-{{ current_letter }}" class="wiki-letter-anchor"></div>
                    {% else %}
                        {% set prev_page_index = loop.index0 - 1 %}
                        {% set prev_letter = section.pages[prev_page_index].title | truncate(length=1, end="") | upper %}
                        {% if prev_letter != current_letter %}
                        <div id="letter-{{ current_letter }}" class="wiki-letter-anchor"></div>
                        {% endif %}
                    {% endif %}

                    <div class="wiki-card__header">
                        <h3 class="wiki-card__title">
                            <a href="{{ page.permalink }}" class="wiki-card__link">{{ page.title }}</a>
                        </h3>
                        {% if page.extra.category %}
                        <span class="wiki-card__category">{{ page.extra.category }}</span>
                        {% endif %}
                    </div>

                    {% if page.extra.summary or page.description %}
                    <div class="wiki-card__summary">
                        {{ page.extra.summary | default(value=page.description) }}
                    </div>
                    {% endif %}

                    <!-- Alternative names preview -->
                    {% if page.extra.alternative_names %}
                    <div class="wiki-card__alternatives">
                        <span class="wiki-card__alternatives-label">Also:</span>
                        {% for name in page.extra.alternative_names | slice(end=3) %}
                        <span class="wiki-card__alternative-name">{{ name }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if page.extra.alternative_names | length > 3 %}
                        <span class="wiki-card__alternatives-more">+{{ page.extra.alternative_names | length - 3 }} more</span>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="wiki-card__meta">
                        {% if page.date %}
                        <time class="wiki-card__date">
                            Updated {{ page.date | date(format="%b %d, %Y") }}
                        </time>
                        {% endif %}
                        <span class="wiki-card__read-more">
                            <a href="{{ page.permalink }}" class="wiki-card__read-link">
                                Read more
                                <svg class="wiki-card__arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14"></path>
                                    <path d="M12 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        </span>
                    </div>
                </article>
                {% endfor %}
            </div>

            <!-- No Results Message -->
            <div class="wiki-no-results hidden" id="wiki-no-results">
                <div class="wiki-no-results__content">
                    <svg class="wiki-no-results__icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <h3 class="wiki-no-results__title">No articles found</h3>
                    <p class="wiki-no-results__message">Try adjusting your search terms or topic filter.</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if section.subsections %}
        <div class="wiki-section__subsections">
            <h2 class="wiki-section__subsections-title">Categories</h2>
            <div class="wiki-section__subsection-grid">
                {% for subsection_path in section.subsections %} {% set
                subsection = get_section(path=subsection_path) %}
                <div class="wiki-subsection-card">
                    <h3 class="wiki-subsection-card__title">
                        <a
                            href="{{ subsection.permalink }}"
                            class="wiki-subsection-card__link"
                        >
                            {{ subsection.title }}
                        </a>
                    </h3>
                    {% if subsection.description %}
                    <p class="wiki-subsection-card__description">
                        {{ subsection.description }}
                    </p>
                    {% endif %} {% if subsection.pages %}
                    <div class="wiki-subsection-card__count">
                        {{ subsection.pages | length }} {% if subsection.pages |
                        length == 1 %}page{% else %}pages{% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Discovery Footer (About the Wiki) -->
        {% if section.pages %}
        <footer class="wiki-footer">
            <div class="wiki-footer__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <path d="M8 7h8"></path>
                    <path d="M8 11h8"></path>
                    <path d="M8 15h6"></path>
                </svg>
            </div>
            <h2 class="wiki-footer__title">About This Encyclopedia</h2>
            {% if section.description %}
            <p class="wiki-footer__description">{{ section.description }}</p>
            {% endif %}

            <!-- Statistics -->
            <div class="wiki-footer__stats">
                <div class="wiki-footer__stat">
                    <span class="wiki-footer__stat-number">{{ section.pages | length }}</span>
                    <span class="wiki-footer__stat-label">Articles</span>
                </div>
                {% set categories = section.pages | map(attribute="extra.category") | unique %}
                {% set category_count = 0 %}
                {% for cat in categories %}{% if cat %}{% set_global category_count = category_count + 1 %}{% endif %}{% endfor %}
                {% if category_count > 0 %}
                <div class="wiki-footer__stat">
                    <span class="wiki-footer__stat-number">{{ category_count }}</span>
                    <span class="wiki-footer__stat-label">Topics</span>
                </div>
                {% endif %}
                {% set total_words = 0 %}
                {% for page in section.pages %}
                    {% set_global total_words = total_words + page.word_count %}
                {% endfor %}
                <div class="wiki-footer__stat">
                    <span class="wiki-footer__stat-number">{{ (total_words / 1000) | round }}k</span>
                    <span class="wiki-footer__stat-label">Words</span>
                </div>
            </div>

            <!-- Recently Updated -->
            {% set pages_with_dates = section.pages | filter(attribute="date") %}
            {% if pages_with_dates | length > 0 %}
            {% set recent_pages = pages_with_dates | sort(attribute="date") | reverse | slice(end=4) %}
            <div class="wiki-footer__recent">
                <h3 class="wiki-footer__recent-title">Recently Updated</h3>
                <div class="wiki-footer__recent-grid">
                    {% for page in recent_pages %}
                    <a href="{{ page.permalink }}" class="wiki-footer__recent-link">
                        {{ page.title }}
                        {% if page.date %}
                        <span class="wiki-footer__recent-date">{{ page.date | date(format="%b %d") }}</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </footer>
        {% endif %}
    </div>
</div>

<script>
// Wiki Discovery JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('wiki-search');
    const categoryFilter = document.getElementById('wiki-category-filter');
    const sortSelect = document.getElementById('wiki-sort');
    const viewToggle = document.querySelectorAll('.wiki-view-toggle__btn');
    const articlesContainer = document.getElementById('wiki-articles');
    const noResults = document.getElementById('wiki-no-results');
    const articles = Array.from(document.querySelectorAll('.wiki-card'));
    const randomBtn = document.getElementById('random-article-btn');

    // Random article functionality
    if (randomBtn && articles.length > 0) {
        randomBtn.addEventListener('click', function() {
            const randomIndex = Math.floor(Math.random() * articles.length);
            const randomArticle = articles[randomIndex];
            const link = randomArticle.querySelector('.wiki-card__link');
            if (link) {
                window.location.href = link.href;
            }
        });
    }

    // Search functionality
    function filterArticles() {
        const searchTerm = searchInput?.value.toLowerCase() || '';
        const selectedCategory = categoryFilter?.value || '';
        let visibleCount = 0;

        articles.forEach(article => {
            const title = article.dataset.title || '';
            const category = article.dataset.category || '';

            const matchesSearch = title.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory.toLowerCase();

            if (matchesSearch && matchesCategory) {
                article.style.display = '';
                visibleCount++;
            } else {
                article.style.display = 'none';
            }
        });

        if (noResults) {
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    }

    // Sort functionality
    function sortArticles() {
        if (!sortSelect) return;

        const sortBy = sortSelect.value;
        const container = articlesContainer;

        const sortedArticles = [...articles].sort((a, b) => {
            switch (sortBy) {
                case 'title':
                    return (a.dataset.title || '').localeCompare(b.dataset.title || '');
                case 'date':
                    const dateA = new Date(a.dataset.date || '1970-01-01');
                    const dateB = new Date(b.dataset.date || '1970-01-01');
                    return dateB - dateA; // Newest first
                case 'category':
                    const catA = a.dataset.category || 'zzz';
                    const catB = b.dataset.category || 'zzz';
                    return catA.localeCompare(catB);
                default:
                    return 0;
            }
        });

        // Re-append in sorted order
        sortedArticles.forEach(article => container.appendChild(article));
    }

    // View toggle functionality
    function toggleView(view) {
        if (!articlesContainer) return;

        articlesContainer.dataset.view = view;

        viewToggle.forEach(btn => {
            btn.classList.toggle('wiki-view-toggle__btn--active', btn.dataset.view === view);
        });
    }

    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterArticles);
    }

    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterArticles);
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', sortArticles);
    }

    viewToggle.forEach(btn => {
        btn.addEventListener('click', () => toggleView(btn.dataset.view));
    });

    // Smooth scroll for alphabet navigation
    document.querySelectorAll('.wiki-alphabet__link--active').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
});
</script>

{% endblock content %}
