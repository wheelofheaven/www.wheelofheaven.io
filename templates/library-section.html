{% extends "base.html" %}
{% import "macros/library.html" as library_macros %}

{% block content %}
{# Load catalog for auto-discovery #}
{% set catalog = load_data(path="data/library/catalog.json") %}

{# Pre-calculate statistics #}
{% set total_books = 0 %}
{% set available_books = 0 %}
{% set total_chapters = 0 %}
{% set total_paragraphs = 0 %}
{% set all_languages = [] %}

{# Load all book data and calculate stats #}
{% set books_data = [] %}
{% for book_entry in catalog.books %}
    {% if book_entry.status == "complete" or book_entry.status == "partial" %}
        {% set book_file = "data/library/" ~ book_entry.slug ~ ".json" %}
        {% set book_data = load_data(path=book_file, required=false) %}
        {% if book_data %}
            {% set_global available_books = available_books + 1 %}
            {% set_global total_chapters = total_chapters + book_entry.chapters %}
            {% set_global total_paragraphs = total_paragraphs + book_entry.paragraphs %}
            {% for lang in book_entry.availableLangs %}
                {% if lang not in all_languages %}
                    {% set_global all_languages = all_languages | concat(with=lang) %}
                {% endif %}
            {% endfor %}
            {% set_global books_data = books_data | concat(with=book_data) %}
        {% endif %}
    {% endif %}
    {% set_global total_books = total_books + 1 %}
{% endfor %}

<div class="library-section">
    <div class="library-section__container">
        <!-- Header with Search -->
        <header class="library-header">
            <div class="library-header__left">
                <h1 class="library-header__title">{{ section.title }}</h1>
                <span class="library-header__count">{{ available_books }} {% if available_books == 1 %}Text{% else %}Texts{% endif %} Available</span>
            </div>
            <div class="library-header__search">
                <svg class="library-header__search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       class="library-header__search-input"
                       placeholder="Search library..."
                       id="library-search"
                       autocomplete="off">
            </div>
        </header>

        <!-- Filter Bar (Sefaria-inspired) -->
        <div class="library-filters">
            <div class="library-filters__left">
                <div class="library-filters__traditions" role="tablist" aria-label="Filter by tradition">
                    <button class="library-filters__tradition library-filters__tradition--active"
                            data-tradition="all"
                            role="tab"
                            aria-selected="true">
                        All
                    </button>
                    {% for tradition in catalog.traditions %}
                    <button class="library-filters__tradition"
                            data-tradition="{{ tradition.id }}"
                            role="tab"
                            aria-selected="false">
                        {{ tradition.name[detected_lang] | default(value=tradition.name.en) }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="library-filters__right">
                <!-- Random Book -->
                <button class="library-filters__random" id="random-book-btn" title="Random book">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 3h5v5"></path>
                        <path d="M4 20L21 3"></path>
                        <path d="M21 16v5h-5"></path>
                        <path d="M15 15l6 6"></path>
                        <path d="M4 4l5 5"></path>
                    </svg>
                    <span class="library-filters__random-text">Random</span>
                </button>
            </div>
        </div>

        <!-- Books by Tradition (Sefaria-style organization) -->
        <div class="library-section__books" id="library-books">
            {% for tradition in catalog.traditions %}
            {% set_global tradition_has_books = false %}
            {% for book_entry in catalog.books %}
                {% if book_entry.tradition == tradition.id and (book_entry.status == "complete" or book_entry.status == "partial") %}
                    {% set_global tradition_has_books = true %}
                {% endif %}
            {% endfor %}

            {% if tradition_has_books %}
            <section class="library-tradition" data-tradition="{{ tradition.id }}">
                <header class="library-tradition__header">
                    <div class="library-tradition__icon">
                        {% if tradition.icon == "message-circle" %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                        {% elif tradition.icon == "book-open" %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                        {% elif tradition.icon == "rocket" %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                            <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                            <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                            <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
                        </svg>
                        {% elif tradition.icon == "scroll" %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"></path>
                            <path d="M19 17V5a2 2 0 0 0-2-2H4"></path>
                        </svg>
                        {% else %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="library-tradition__info">
                        <h2 class="library-tradition__title">{{ tradition.name[detected_lang] | default(value=tradition.name.en) }}</h2>
                        <p class="library-tradition__description">{{ tradition.description[detected_lang] | default(value=tradition.description.en) }}</p>
                    </div>
                </header>

                <div class="books-grid">
                    {% for book_entry in catalog.books %}
                    {% if book_entry.tradition == tradition.id and (book_entry.status == "complete" or book_entry.status == "partial") %}
                        {# Try split format first, fall back to single file #}
                        {% set book_meta = load_data(path="data/library/" ~ book_entry.slug ~ "/_meta.json", required=false) %}
                        {% if book_meta %}
                            {% set_global book_data = book_meta %}
                            {% set_global first_chapter = load_data(path="data/library/" ~ book_entry.slug ~ "/chapter-1.json", required=false) %}
                        {% else %}
                            {% set_global book_data = load_data(path="data/library/" ~ book_entry.slug ~ ".json", required=false) %}
                            {% if book_data and book_data.chapters %}
                                {% set_global first_chapter = book_data.chapters | first %}
                            {% endif %}
                        {% endif %}
                        {% if book_data %}
                        <article class="book-card"
                                 data-title="{{ library_macros::get_book_title(book_data=book_data, lang=detected_lang) | lower }}"
                                 data-tradition="{{ book_entry.tradition }}"
                                 data-collection="{{ book_entry.collection }}"
                                 data-code="{{ book_entry.code }}"
                                 data-status="{{ book_entry.status }}"
                                 data-tags="{{ book_entry.tags | join(sep=',') }}">
                            <!-- Accent stripe -->
                            <div class="book-card__accent"></div>

                            <!-- Status badge for partial books -->
                            {% if book_entry.status == "partial" %}
                            <div class="book-card__status book-card__status--partial">
                                <span>In Progress</span>
                            </div>
                            {% endif %}

                            <!-- Book icon with code -->
                            <div class="book-card__icon">
                                <span class="book-card__code">{{ book_entry.code }}</span>
                            </div>

                            <div class="book-card__content">
                                <!-- Languages as badges at top -->
                                <div class="book-card__languages">
                                    {% for lang_code in book_entry.availableLangs %}
                                    <span class="book-card__language-tag {% if lang_code in book_entry.completeLangs %}book-card__language-tag--complete{% endif %}"
                                          title="{% if lang_code in book_entry.completeLangs %}Complete translation{% else %}Partial translation{% endif %}">
                                        {{ lang_code | upper }}
                                    </span>
                                    {% endfor %}
                                </div>

                                <h3 class="book-card__title">
                                    <a href="{{ get_url(path='library/' ~ book_data.slug, lang=detected_lang) }}" class="book-card__link">
                                        {{ library_macros::get_book_title(book_data=book_data, lang=detected_lang) }}
                                    </a>
                                </h3>

                                {% if book_data.primaryLang != detected_lang and book_data.titles[book_data.primaryLang] %}
                                <p class="book-card__original-title">
                                    <span class="book-card__original-label">Original:</span>
                                    {{ book_data.titles[book_data.primaryLang] }}
                                </p>
                                {% endif %}

                                {% if first_chapter and first_chapter.paragraphs and first_chapter.paragraphs[0] %}
                                <div class="book-card__preview">
                                    {% set first_paragraph = first_chapter.paragraphs[0] %}
                                    <p class="book-card__preview-text">
                                        {{ library_macros::get_paragraph_text(paragraph=first_paragraph, lang=detected_lang) | truncate(length=180) }}
                                    </p>
                                </div>
                                {% endif %}

                                <div class="book-card__meta">
                                    <span class="book-card__meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                        </svg>
                                        {{ book_entry.chapters }} chapters
                                    </span>
                                    <span class="book-card__meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        {{ book_entry.paragraphs }} paragraphs
                                    </span>
                                    {% if book_entry.publicationYear %}
                                    <span class="book-card__meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg>
                                        {{ book_entry.publicationYear }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="book-card__footer">
                                <a href="{{ get_url(path='library/' ~ book_data.slug, lang=detected_lang) }}" class="book-card__read-btn">
                                    <span>Start Reading</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12h14"></path>
                                        <path d="M12 5l7 7-7 7"></path>
                                    </svg>
                                </a>
                            </div>
                        </article>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}
            {% endfor %}

            <!-- Planned Books Section -->
            {% set_global has_planned = false %}
            {% for book_entry in catalog.books %}
                {% if book_entry.status == "planned" %}
                    {% set_global has_planned = true %}
                {% endif %}
            {% endfor %}

            {% if has_planned %}
            <section class="library-tradition library-tradition--planned" data-tradition="planned">
                <header class="library-tradition__header">
                    <div class="library-tradition__icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="library-tradition__info">
                        <h2 class="library-tradition__title">Coming Soon</h2>
                        <p class="library-tradition__description">These texts are planned for future digitization and translation.</p>
                    </div>
                </header>

                <div class="books-grid books-grid--planned">
                    {% for book_entry in catalog.books %}
                    {% if book_entry.status == "planned" %}
                    <article class="book-card book-card--planned" data-tradition="{{ book_entry.tradition }}">
                        <div class="book-card__icon">
                            <span class="book-card__code">{{ book_entry.code }}</span>
                        </div>
                        <div class="book-card__content">
                            <h3 class="book-card__title">
                                {% set tradition_data = false %}
                                {% for t in catalog.traditions %}
                                    {% if t.id == book_entry.tradition %}
                                        {% set_global tradition_data = t %}
                                    {% endif %}
                                {% endfor %}
                                {% if tradition_data %}
                                <span class="book-card__tradition-tag">{{ tradition_data.name.en }}</span>
                                {% endif %}
                                <span class="book-card__planned-title">{{ book_entry.originalTitle }}</span>
                            </h3>
                            {% if book_entry.author %}
                            <p class="book-card__author">{{ book_entry.author }}</p>
                            {% endif %}
                        </div>
                    </article>
                    {% endif %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>

        <!-- No Search Results Message -->
        <div class="library-no-results hidden" id="library-no-results">
            <div class="library-no-results__content">
                <svg class="library-no-results__icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <h3 class="library-no-results__title">No books found</h3>
                <p class="library-no-results__message">Try adjusting your search or filter.</p>
                <button class="library-no-results__reset" onclick="resetFilters()">Show All Books</button>
            </div>
        </div>

        <!-- Discovery Footer (About Library) - Dynamic Stats -->
        <footer class="library-footer">
            <div class="library-footer__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <path d="M8 7h8"></path>
                    <path d="M8 11h8"></path>
                    <path d="M8 15h6"></path>
                </svg>
            </div>
            <h2 class="library-footer__title">About the Library</h2>
            {% if section.description %}
            <p class="library-footer__description">{{ section.description }}</p>
            {% endif %}

            <!-- Features -->
            <div class="library-footer__features">
                <div class="library-footer__feature">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span>Original Language</span>
                </div>
                <div class="library-footer__feature">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span>Multiple Translations</span>
                </div>
                <div class="library-footer__feature">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    <span>Side-by-Side View</span>
                </div>
                <div class="library-footer__feature">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Bookmarks & Notes</span>
                </div>
            </div>

            <!-- Dynamic Stats -->
            <div class="library-footer__stats">
                <div class="library-footer__stat">
                    <span class="library-footer__stat-number">{{ available_books }}</span>
                    <span class="library-footer__stat-label">{% if available_books == 1 %}Book{% else %}Books{% endif %}</span>
                </div>
                <div class="library-footer__stat">
                    <span class="library-footer__stat-number">{{ all_languages | length }}+</span>
                    <span class="library-footer__stat-label">Languages</span>
                </div>
                <div class="library-footer__stat">
                    <span class="library-footer__stat-number">{{ total_chapters }}</span>
                    <span class="library-footer__stat-label">Chapters</span>
                </div>
                <div class="library-footer__stat">
                    <span class="library-footer__stat-number">{{ total_paragraphs | filesizeformat | replace(from=" B", to="") }}</span>
                    <span class="library-footer__stat-label">Paragraphs</span>
                </div>
            </div>

            <!-- Reference Format Guide -->
            <div class="library-footer__reference">
                <h3 class="library-footer__reference-title">Reference Format</h3>
                <p class="library-footer__reference-text">
                    Use canonical references like <code>TBWTT 1:5</code> to cite specific passages.
                    Format: <code>[Book Code] [Chapter]:[Paragraph]</code>
                </p>
            </div>
        </footer>
    </div>
</div>

<script>
// Library Discovery JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('library-search');
    const booksContainer = document.getElementById('library-books');
    const noResults = document.getElementById('library-no-results');
    const books = Array.from(document.querySelectorAll('.book-card:not(.book-card--planned)'));
    const traditions = document.querySelectorAll('.library-tradition:not(.library-tradition--planned)');
    const traditionButtons = document.querySelectorAll('.library-filters__tradition');
    const randomBtn = document.getElementById('random-book-btn');

    let currentTradition = 'all';

    // Tradition filter functionality
    traditionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tradition = this.dataset.tradition;
            currentTradition = tradition;

            // Update active state
            traditionButtons.forEach(btn => {
                btn.classList.remove('library-filters__tradition--active');
                btn.setAttribute('aria-selected', 'false');
            });
            this.classList.add('library-filters__tradition--active');
            this.setAttribute('aria-selected', 'true');

            filterBooks();
        });
    });

    // Random book functionality
    if (randomBtn && books.length > 0) {
        randomBtn.addEventListener('click', function() {
            const visibleBooks = books.filter(book => book.style.display !== 'none');
            if (visibleBooks.length > 0) {
                const randomIndex = Math.floor(Math.random() * visibleBooks.length);
                const randomBook = visibleBooks[randomIndex];
                const link = randomBook.querySelector('.book-card__link');
                if (link) {
                    window.location.href = link.href;
                }
            }
        });
    }

    // Search and filter functionality
    function filterBooks() {
        const searchTerm = searchInput?.value.toLowerCase() || '';
        let visibleCount = 0;

        books.forEach(book => {
            const title = book.dataset.title || '';
            const tradition = book.dataset.tradition || '';
            const tags = book.dataset.tags || '';
            const code = book.dataset.code || '';

            const matchesSearch = !searchTerm ||
                title.includes(searchTerm) ||
                tags.includes(searchTerm) ||
                code.toLowerCase().includes(searchTerm);

            const matchesTradition = currentTradition === 'all' || tradition === currentTradition;

            if (matchesSearch && matchesTradition) {
                book.style.display = '';
                visibleCount++;
            } else {
                book.style.display = 'none';
            }
        });

        // Show/hide tradition sections based on visible books
        traditions.forEach(section => {
            const sectionTradition = section.dataset.tradition;
            const visibleInSection = Array.from(section.querySelectorAll('.book-card')).some(
                book => book.style.display !== 'none'
            );

            if (currentTradition === 'all') {
                section.style.display = visibleInSection ? '' : 'none';
            } else {
                section.style.display = sectionTradition === currentTradition ? '' : 'none';
            }
        });

        // Show/hide no results message
        if (noResults) {
            noResults.classList.toggle('hidden', visibleCount > 0);
        }
    }

    // Reset filters
    window.resetFilters = function() {
        if (searchInput) searchInput.value = '';
        currentTradition = 'all';
        traditionButtons.forEach(btn => {
            btn.classList.remove('library-filters__tradition--active');
            btn.setAttribute('aria-selected', 'false');
        });
        traditionButtons[0]?.classList.add('library-filters__tradition--active');
        traditionButtons[0]?.setAttribute('aria-selected', 'true');
        filterBooks();
    };

    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterBooks);
    }

    // Initial filter
    filterBooks();
});
</script>

{% endblock content %}
