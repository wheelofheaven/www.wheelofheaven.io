{% extends "base.html" %} {% import "macros/library.html" as library_macros %}
{% block content %}
<div class="library-book">
    {% set book_slug = page.slug %} {% set book_data =
    load_data(path="data/library/" ~ book_slug ~ ".json") %} {% if book_data %}

    <div class="library-book__container">
        <!-- Table of Contents Sidebar -->
        <aside class="library-book__toc">
            <div class="library-book__toc-header">
                <h3 class="library-book__toc-title">Contents</h3>
            </div>
            <nav class="library-book__toc-nav">
                <ul class="library-book__toc-list">
                    {% for chapter in book_data.chapters %}
                    <li
                        class="library-book__toc-item"
                        data-chapter="{{ chapter.n }}"
                    >
                        <a
                            href="#chapter-{{ chapter.n }}"
                            class="library-book__toc-link"
                            onclick="scrollToChapter({{ chapter.n }})"
                        >
                            <span class="library-book__toc-chapter-number"
                                >{{ chapter.n }}</span
                            >
                            <span class="library-book__toc-chapter-title">
                                {% if chapter.title %}{{ chapter.title }}{% else
                                %}Chapter {{ chapter.n }}{% endif %}
                            </span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="library-book__content">
            <header class="book-header">
                <h1 class="book-title">
                    {{ library_macros::get_book_title(book_data=book_data,
                    lang=lang) }}
                </h1>

                {% if book_data.primaryLang != lang and
                book_data.titles[book_data.primaryLang] %}
                <p class="book-subtitle">
                    Original: {{ book_data.titles[book_data.primaryLang] }}
                </p>
                {% endif %} {% if book_data.description %}
                <p class="book-description">{{ book_data.description }}</p>
                {% endif %}
            </header>

            <div class="view-controls">
                <div class="language-selector">
                    <label for="language-select">Language:</label>
                    <select
                        id="language-select"
                        onchange="changeLanguage(this.value)"
                    >
                        {% for lang_code, title in book_data.titles %}
                        <option
                            value="{{ lang_code }}"
                            {%
                            if
                            lang_code == lang
                            %}selected{%
                            endif
                            %}
                        >
                            {{ lang_code | upper }} - {{ title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="view-toggle">
                    <label>
                        <input
                            type="checkbox"
                            id="side-by-side-toggle"
                            onchange="toggleSideBySide()"
                        />
                        Side-by-side view
                    </label>
                </div>

                <button onclick="toggleOriginalText()" id="original-toggle">
                    Show Original
                </button>
            </div>

            <main class="chapter-content">
                {% for chapter in book_data.chapters %}
                <section class="chapter" id="chapter-{{ chapter.n }}">
                    <header class="chapter-header">
                        <h2 class="chapter-title">Chapter {{ chapter.n }}</h2>
                        {% if chapter.title %}
                        <p class="chapter-number">{{ chapter.title }}</p>
                        {% endif %}
                    </header>

                    <div class="text-content" id="text-content-{{ chapter.n }}">
                        {% for paragraph in chapter.paragraphs %}
                        <div
                            class="paragraph"
                            id="c{{ chapter.n }}p{{ paragraph.n }}"
                            onclick="selectParagraph('c{{ chapter.n }}p{{ paragraph.n }}')"
                        >
                            <div class="paragraph-number">
                                {{ paragraph.n }}
                            </div>

                            <div class="paragraph-content">
                                <div class="original-text">
                                    {{ paragraph.text }}
                                </div>

                                {% if lang != book_data.primaryLang and
                                paragraph.i18n and paragraph.i18n[lang] %}
                                <div class="translation-text">
                                    {{ paragraph.i18n[lang] }}
                                </div>
                                {% endif %}
                            </div>

                            <button
                                class="share-button"
                                onclick="shareParagraph('c{{ chapter.n }}p{{ paragraph.n }}')"
                                title="Share this paragraph"
                            >
                                <svg
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"
                                    ></path>
                                    <polyline points="16,6 12,2 8,6"></polyline>
                                    <line x1="12" y1="2" x2="12" y2="15"></line>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endfor %}
            </main>

            <nav class="chapter-navigation">
                <button
                    class="nav-button prev"
                    onclick="previousChapter()"
                    id="prev-chapter"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                    Previous
                </button>

                <div class="chapter-info">
                    <div class="current-chapter" id="current-chapter-display">
                        Chapter 1 of {{ book_data.chapters | length }}
                    </div>
                    <div class="chapter-progress" id="chapter-progress">
                        Reading Chapter 1
                    </div>
                </div>

                <button
                    class="nav-button next"
                    onclick="nextChapter()"
                    id="next-chapter"
                >
                    Next
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M9 18l6-6-6-6"></path>
                    </svg>
                </button>
            </nav>

            <nav class="book-navigation">
                <a href="{{ get_url(path='library') }}" class="back-to-library">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M15 18l-6-6 6-6"></path>
                    </svg>
                    Back to Library
                </a>
            </nav>
        </div>
    </div>

    {% else %}
    <div class="book-not-found">
        <h1>Book Not Found</h1>
        <p>The requested book could not be found or failed to load.</p>
        <a href="{{ get_url(path='library') }}">Return to Library</a>
    </div>
    {% endif %}
</div>

<script>
    let currentChapter = 1;
    const totalChapters = {% if book_data and book_data.chapters %}{{ book_data.chapters | length }}{% else %}0{% endif %};
    const bookTitle = "{{ library_macros::get_book_title(book_data=book_data, lang=lang) }}";
    let showingOriginal = false;
    let sideBySide = false;
    let selectedParagraph = null;

    function toggleOriginalText() {
        const originalTexts = document.querySelectorAll('.original-text');
        const button = document.getElementById('original-toggle');
        showingOriginal = !showingOriginal;

        originalTexts.forEach(text => {
            text.style.display = showingOriginal ? 'block' : 'none';
        });

        button.textContent = showingOriginal ? 'Hide Original' : 'Show Original';
    }

    function toggleSideBySide() {
        const textContents = document.querySelectorAll('.text-content');
        sideBySide = !sideBySide;

        textContents.forEach(content => {
            if (sideBySide) {
                content.classList.add('side-by-side');
            } else {
                content.classList.remove('side-by-side');
            }
        });
    }

    function selectParagraph(paragraphId) {
        // Remove selection from all paragraphs
        document.querySelectorAll('.paragraph').forEach(p => {
            p.classList.remove('selected');
        });

        // Select the clicked paragraph
        const paragraph = document.getElementById(paragraphId);
        if (paragraph) {
            paragraph.classList.add('selected');
            selectedParagraph = paragraphId;

            // Update URL hash without scrolling
            const newUrl = window.location.pathname + window.location.search + '#' + paragraphId;
            history.replaceState(null, null, newUrl);
        }
    }

    function shareParagraph(paragraphId) {
        const paragraph = document.getElementById(paragraphId);
        if (!paragraph) return;

        let textToCopy = '';

        // Get the paragraph text
        const translatedText = paragraph.querySelector('.translation-text');
        const originalText = paragraph.querySelector('.original-text');

        if (translatedText && translatedText.textContent.trim()) {
            textToCopy = translatedText.textContent.trim();
        } else if (originalText && originalText.textContent.trim()) {
            textToCopy = originalText.textContent.trim();
        }

        if (!textToCopy) {
            if (typeof window.showCopyError === 'function') {
                window.showCopyError();
            }
            return;
        }

        // Extract chapter and paragraph numbers from ID (format: c1p2 = chapter 1, paragraph 2)
        const match = paragraphId.match(/^c(\d+)p(\d+)$/);
        const chapterNum = match ? match[1] : '?';
        const paraNum = match ? match[2] : '?';

        // Create shareable content with URL
        const currentUrl = window.location.origin + window.location.pathname + '#' + paragraphId;
        const shareText = `"${textToCopy}"\n\n— ${bookTitle}, Chapter ${chapterNum}, Paragraph ${paraNum}\n${currentUrl}`;

        // Check if Web Share API is available and we're on HTTPS
        if (navigator.share && window.location.protocol === 'https:') {
            navigator.share({
                title: bookTitle + ' - Chapter ' + chapterNum + ', Paragraph ' + paraNum,
                text: shareText,
                url: currentUrl
            }).then(() => {
                if (typeof window.showCopySuccess === 'function') {
                    window.showCopySuccess();
                }
            }).catch(() => {
                copyToClipboard(shareText);
            });
        } else {
            copyToClipboard(shareText);
        }
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                if (typeof window.showCopySuccess === 'function') {
                    window.showCopySuccess();
                }
            }).catch(() => {
                fallbackCopyToClipboard(text);
            });
        } else {
            fallbackCopyToClipboard(text);
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
                if (typeof window.showCopySuccess === 'function') {
                    window.showCopySuccess();
                }
            } else {
                throw new Error('execCommand failed');
            }
        } catch (err) {
            document.body.removeChild(textArea);
            if (typeof window.showCopyError === 'function') {
                window.showCopyError();
            }
        }
    }

    function updateTocHighlight() {
        const tocItems = document.querySelectorAll('.library-book__toc-item');
        const chapters = document.querySelectorAll('.chapter');

        let activeChapter = null;
        const scrollPosition = window.scrollY + 200;

        chapters.forEach(chapter => {
            const chapterTop = chapter.offsetTop;
            const chapterBottom = chapterTop + chapter.offsetHeight;

            if (scrollPosition >= chapterTop && scrollPosition < chapterBottom) {
                activeChapter = chapter.id.replace('chapter-', '');
            }
        });

        tocItems.forEach(item => {
            const chapterNumber = item.dataset.chapter;
            if (chapterNumber === activeChapter) {
                item.classList.add('active');
                currentChapter = parseInt(activeChapter);
            } else {
                item.classList.remove('active');
            }
        });

        updateChapterNavigation();
    }

    function updateChapterNavigation() {
        const prevButton = document.getElementById('prev-chapter');
        const nextButton = document.getElementById('next-chapter');
        const currentDisplay = document.getElementById('current-chapter-display');
        const progressDisplay = document.getElementById('chapter-progress');

        if (prevButton) prevButton.classList.toggle('disabled', currentChapter <= 1);
        if (nextButton) nextButton.classList.toggle('disabled', currentChapter >= totalChapters);

        if (currentDisplay) {
            currentDisplay.textContent = `Chapter ${currentChapter} of ${totalChapters}`;
        }

        if (progressDisplay) {
            progressDisplay.textContent = `Reading Chapter ${currentChapter}`;
        }
    }

    function previousChapter() {
        if (currentChapter > 1) {
            currentChapter--;
            scrollToChapter(currentChapter);
        }
    }

    function nextChapter() {
        if (currentChapter < totalChapters) {
            currentChapter++;
            scrollToChapter(currentChapter);
        }
    }

    function scrollToChapter(chapterNumber) {
        const chapter = document.getElementById('chapter-' + chapterNumber);
        if (chapter) {
            chapter.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            currentChapter = chapterNumber;
            updateTocHighlight();
        }
    }

    function changeLanguage(newLang) {
        const currentPath = window.location.pathname;
        const newPath = currentPath.replace(/^\/[a-z]{2}\//, '/' + newLang + '/');
        window.location.href = newPath + (window.location.hash || '');
    }



    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Hide original text by default
        toggleOriginalText();

        // Update navigation state
        updateChapterNavigation();

        // Set up scroll listener for ToC highlighting
        let ticking = false;
        function handleScroll() {
            if (!ticking) {
                requestAnimationFrame(function() {
                    updateTocHighlight();
                    ticking = false;
                });
                ticking = true;
            }
        }

        window.addEventListener('scroll', handleScroll, { passive: true });

        // Initial ToC highlight
        setTimeout(updateTocHighlight, 100);

        // Handle deep linking to paragraphs
        if (window.location.hash) {
            const hashValue = window.location.hash.substring(1);
            // Handle both old format (#paragraph-N) and new format (#c1p2)
            if (hashValue.startsWith('paragraph-')) {
                // Legacy format - convert to new format assuming chapter 1
                const paragraphNumber = hashValue.replace('paragraph-', '');
                const newId = 'c1p' + paragraphNumber;
                setTimeout(() => {
                    selectParagraph(newId);
                    document.getElementById(newId)?.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 500);
            } else if (hashValue.match(/^c\d+p\d+$/)) {
                // New format
                setTimeout(() => {
                    selectParagraph(hashValue);
                    document.getElementById(hashValue)?.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 500);
            }
        }

        // Handle deep linking to chapters
        if (window.location.hash && window.location.hash.startsWith('#chapter-')) {
            const chapterNumber = window.location.hash.replace('#chapter-', '');
            setTimeout(() => {
                scrollToChapter(parseInt(chapterNumber));
            }, 500);
        }
    });
</script>

{% endblock content %}
