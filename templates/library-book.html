{% extends "base.html" %}
{% import "macros/library.html" as library_macros %}
{% import "macros/breadcrumbs.html" as breadcrumbs %}

{% block content %}
{% set book_slug = page.slug %}
{% set catalog = load_data(path="data/library/catalog.json") %}

{# Try split format first (directory with _meta.json), fall back to single file #}
{% set book_meta = load_data(path="data/library/" ~ book_slug ~ "/_meta.json", required=false) %}
{% if book_meta %}
    {# Split format: load chapters from separate files #}
    {% set_global book_data = book_meta %}
    {% set_global book_chapters = [] %}
    {% for ch_info in book_meta.chapterFiles %}
        {% set chapter_data = load_data(path="data/library/" ~ book_slug ~ "/" ~ ch_info.file, required=false) %}
        {% if chapter_data %}
            {% set_global book_chapters = book_chapters | concat(with=[chapter_data]) %}
        {% endif %}
    {% endfor %}
{% else %}
    {# Single file format #}
    {% set_global book_data = load_data(path="data/library/" ~ book_slug ~ ".json", required=false) %}
    {% if book_data %}
        {% set_global book_chapters = book_data.chapters %}
    {% endif %}
{% endif %}

{% if book_data %}
<!-- Book Schema for Library Pages -->
{% include "partials/schema/book.html" %}

<div class="library-book" data-book-slug="{{ book_slug }}" data-book-code="{{ book_data.code | default(value='') }}">
    <!-- Breadcrumb Navigation -->
    {{ breadcrumbs::library(book_title=library_macros::get_book_title(book_data=book_data, lang=detected_lang), lang=detected_lang) }}

    <div class="library-book__container">
        <!-- Table of Contents Sidebar -->
        <aside class="library-book__toc" role="complementary" aria-label="Book table of contents">
            <div class="library-book__toc-header">
                <h3 class="library-book__toc-title" id="book-toc-heading">Contents</h3>
            </div>
            <nav class="library-book__toc-nav" aria-labelledby="book-toc-heading">
                <ul class="library-book__toc-list">
                    {% for chapter in book_chapters %}
                    <li class="library-book__toc-item" data-chapter="{{ chapter.n }}">
                        <a href="#chapter-{{ chapter.n }}" class="library-book__toc-link" onclick="scrollToChapter({{ chapter.n }})">
                            <span class="library-book__toc-chapter-number">{{ chapter.n }}</span>
                            <span class="library-book__toc-chapter-title">
                                {% if chapter.title %}{{ chapter.title }}{% else %}Chapter {{ chapter.n }}{% endif %}
                            </span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="library-book__main">
            <article class="library-book__article" role="article" aria-labelledby="book-title">

                <!-- Book Header -->
                <header class="library-book__header">
                    <h1 class="library-book__title" id="book-title">
                        {{ library_macros::get_book_title(book_data=book_data, lang=detected_lang) }}
                    </h1>

                    {% if book_data.primaryLang != lang and book_data.titles[book_data.primaryLang] %}
                    <div class="library-book__original-title">
                        <span class="library-book__original-label">Original title:</span>
                        <span class="library-book__original-text">{{ book_data.titles[book_data.primaryLang] }}</span>
                    </div>
                    {% endif %}

                    {% if book_data.description %}
                    <div class="library-book__summary" data-ai-summary="true" aria-label="Book summary">
                        <div class="library-book__summary-label">About this book</div>
                        <div class="library-book__summary-content">{{ book_data.description }}</div>
                    </div>
                    {% endif %}

                    <!-- Book Metadata -->
                    <div class="library-book__meta">
                        {% if book_chapters %}
                        <span class="library-book__meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            {{ book_chapters | length }} chapters
                        </span>
                        {% endif %}
                        <span class="library-book__meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            {{ book_data.titles | length }} languages
                        </span>
                        {% if book_data.updated %}
                        <span class="library-book__meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Updated {{ book_data.updated | date(format="%B %d, %Y") }}
                        </span>
                        {% endif %}
                    </div>
                </header>

                <!-- View Controls -->
                <div class="library-book__controls">
                    <div class="library-book__progress">
                        <span id="chapter-progress">Chapter 1</span>
                        <span class="library-book__progress-sep">/</span>
                        <span id="paragraph-progress">1</span>
                    </div>

                    <div class="library-book__actions" role="group" aria-label="View controls">
                        <button onclick="toggleToc()" id="toc-toggle" class="library-book__btn library-book__btn--secondary desktop-only" title="Toggle Contents" aria-pressed="true" aria-label="Toggle table of contents visibility">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            <span>Contents</span>
                        </button>

                        <button onclick="toggleOriginalText()" id="original-toggle" class="library-book__btn library-book__btn--secondary" title="Show/Hide Original Text" aria-pressed="false" aria-label="Toggle original language text">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            <span>Original</span>
                        </button>

                        <button onclick="toggleSideBySide()" id="side-by-side-toggle" class="library-book__btn library-book__btn--secondary hidden" title="Toggle Side-by-Side" aria-pressed="false" aria-label="Toggle side-by-side view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="3" x2="12" y2="21"></line>
                            </svg>
                            <span>Split</span>
                        </button>

                        <!-- Settings Button -->
                        <button id="reader-settings-btn" class="library-book__btn library-book__btn--secondary" title="Reader Settings (Shift+?)" aria-label="Open reader settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span class="desktop-only">Settings</span>
                        </button>
                    </div>
                </div>

                <!-- Settings Panel (hidden by default) -->
                <div id="reader-settings-panel" class="library-book__settings-panel hidden">
                    <div class="library-book__settings-section">
                        <h4 class="library-book__settings-title">Font Size</h4>
                        <div class="library-book__settings-options">
                            <button data-font-size="small" class="library-book__settings-btn">A</button>
                            <button data-font-size="medium" class="library-book__settings-btn active">A</button>
                            <button data-font-size="large" class="library-book__settings-btn">A</button>
                            <button data-font-size="x-large" class="library-book__settings-btn">A</button>
                        </div>
                    </div>
                    <div class="library-book__settings-section">
                        <h4 class="library-book__settings-title">Theme</h4>
                        <div class="library-book__settings-options">
                            <button data-reader-theme="auto" class="library-book__settings-btn active">Auto</button>
                            <button data-reader-theme="light" class="library-book__settings-btn">Light</button>
                            <button data-reader-theme="sepia" class="library-book__settings-btn">Sepia</button>
                            <button data-reader-theme="dark" class="library-book__settings-btn">Dark</button>
                        </div>
                    </div>
                    <div class="library-book__settings-section">
                        <p class="library-book__settings-hint">Press <kbd>?</kbd> for keyboard shortcuts</p>
                    </div>
                </div>

                <!-- Book Content -->
                <div class="library-book__content">
                    {% for chapter in book_chapters %}
                    <section class="library-book__chapter" id="chapter-{{ chapter.n }}">
                        <header class="library-book__chapter-header">
                            <span class="library-book__chapter-number">Chapter {{ chapter.n }}</span>
                            {% if chapter.title %}
                            <h2 class="library-book__chapter-title">{{ chapter.title }}</h2>
                            {% endif %}
                        </header>

                        <div class="library-book__text" id="text-content-{{ chapter.n }}">
                            {% for paragraph in chapter.paragraphs %}
                            <div class="library-book__paragraph" id="c{{ chapter.n }}p{{ paragraph.n }}" data-ref-id="{{ paragraph.refId | default(value='') }}" onclick="selectParagraph('c{{ chapter.n }}p{{ paragraph.n }}')">
                                <div class="library-book__para-num">{{ paragraph.n }}</div>
                                <div class="library-book__para-content">
                                    {% set has_translation = paragraph.i18n and paragraph.i18n[lang] %}
                                    <div class="library-book__para-original">{{ paragraph.text }}</div>
                                    <div class="library-book__para-translation">{% if has_translation %}{{ paragraph.i18n[lang] }}{% else %}{{ paragraph.text }}{% endif %}</div>
                                </div>
                                <button class="library-book__share-btn" onclick="event.stopPropagation(); shareParagraph('c{{ chapter.n }}p{{ paragraph.n }}')" title="Share this paragraph">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                        <polyline points="16,6 12,2 8,6"></polyline>
                                        <line x1="12" y1="2" x2="12" y2="15"></line>
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </section>
                    {% endfor %}
                </div>

                <!-- Chapter Navigation -->
                <nav class="library-book__nav" role="navigation" aria-label="Chapter navigation">
                    <button class="library-book__nav-btn library-book__nav-btn--prev" onclick="previousChapter()" id="prev-chapter" aria-label="Go to previous chapter">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M15 18l-6-6 6-6"></path>
                        </svg>
                        <span>Previous Chapter</span>
                    </button>

                    <div class="library-book__nav-info" aria-live="polite">
                        <span id="current-chapter-display">Chapter 1 of {{ book_chapters | length }}</span>
                    </div>

                    <button class="library-book__nav-btn library-book__nav-btn--next" onclick="nextChapter()" id="next-chapter" aria-label="Go to next chapter">
                        <span>Next Chapter</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M9 18l6-6-6-6"></path>
                        </svg>
                    </button>
                </nav>

                <!-- Related Books Section -->
                {% set_global current_book_entry = false %}
                {% for book_entry in catalog.books %}
                    {% if book_entry.slug == book_slug %}
                        {% set_global current_book_entry = book_entry %}
                    {% endif %}
                {% endfor %}

                {% if current_book_entry %}
                {% set_global related_books = [] %}
                {% for book_entry in catalog.books %}
                    {% if book_entry.slug != book_slug and book_entry.status == "complete" %}
                        {% if book_entry.tradition == current_book_entry.tradition or book_entry.collection == current_book_entry.collection %}
                            {% set_global related_books = related_books | concat(with=[book_entry]) %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if related_books | length > 0 %}
                <aside class="library-book__related">
                    <h2 class="library-book__related-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        Related Books
                    </h2>
                    <div class="library-book__related-grid">
                        {% for related in related_books | slice(end=4) %}
                        {% set related_book_data = load_data(path="data/library/" ~ related.slug ~ ".json", required=false) %}
                        <a href="{{ get_url(path='library/' ~ related.slug) }}" class="library-book__related-card">
                            <div class="library-book__related-code">{{ related.code }}</div>
                            <h3 class="library-book__related-name">
                                {% if related_book_data and related_book_data.titles and related_book_data.titles[detected_lang] %}
                                    {{ related_book_data.titles[detected_lang] }}
                                {% elif related_book_data and related_book_data.titles and related_book_data.titles["en"] %}
                                    {{ related_book_data.titles["en"] }}
                                {% else %}
                                    {{ related.slug | replace(from="-", to=" ") | title }}
                                {% endif %}
                            </h3>
                            <div class="library-book__related-meta">
                                {% if related.author %}
                                <span class="library-book__related-author">{{ related.author }}</span>
                                {% endif %}
                                {% if related.chapters > 0 %}
                                <span class="library-book__related-chapters">{{ related.chapters }} chapters</span>
                                {% endif %}
                            </div>
                            {% for tradition in catalog.traditions %}
                                {% if tradition.id == related.tradition %}
                                <div class="library-book__related-tradition">
                                    {% if tradition.name[detected_lang] %}
                                        {{ tradition.name[detected_lang] }}
                                    {% else %}
                                        {{ tradition.name["en"] }}
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </a>
                        {% endfor %}
                    </div>
                </aside>
                {% endif %}
                {% endif %}

                <!-- Back to Library -->
                <div class="library-book__back">
                    <a href="{{ get_url(path='library') }}" class="library-book__back-link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"></path>
                        </svg>
                        Back to Library
                    </a>
                </div>
            </article>
        </main>
    </div>
</div>

{% else %}
<div class="library-book">
    <div class="library-book__not-found">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
        <h1>Book Not Found</h1>
        <p>The requested book could not be found or failed to load.</p>
        <a href="{{ get_url(path='library') }}" class="library-book__back-link">Return to Library</a>
    </div>
</div>
{% endif %}

<script>
let currentChapter = 1;
const totalChapters = {% if book_chapters %}{{ book_chapters | length }}{% else %}0{% endif %};
const bookTitle = "{{ library_macros::get_book_title(book_data=book_data, lang=detected_lang) }}";
let showingOriginal = false;
let sideBySide = false;
let selectedParagraph = null;
let lastScrollY = 0;
let viewControlsVisible = true;
let tocVisible = true;

function toggleOriginalText() {
    const originalTexts = document.querySelectorAll('.library-book__para-original');
    const button = document.getElementById('original-toggle');
    const sideBySideToggle = document.getElementById('side-by-side-toggle');
    showingOriginal = !showingOriginal;

    originalTexts.forEach(text => {
        text.style.display = showingOriginal ? 'block' : 'none';
    });

    if (button) {
        button.classList.toggle('library-book__btn--active', showingOriginal);
    }

    if (sideBySideToggle) {
        sideBySideToggle.classList.toggle('hidden', !showingOriginal);
    }

    if (!showingOriginal && sideBySide) {
        toggleSideBySide();
    }
}

function toggleSideBySide() {
    const textContents = document.querySelectorAll('.library-book__text');
    const button = document.getElementById('side-by-side-toggle');
    sideBySide = !sideBySide;

    textContents.forEach(content => {
        content.classList.toggle('library-book__text--split', sideBySide);
    });

    if (button) {
        button.classList.toggle('library-book__btn--active', sideBySide);
    }
}

function toggleToc() {
    const tocSidebar = document.querySelector('.library-book__toc');
    const container = document.querySelector('.library-book__container');
    const button = document.getElementById('toc-toggle');

    if (!tocSidebar || !container || !button) return;

    tocVisible = !tocVisible;

    if (tocVisible) {
        tocSidebar.style.display = 'block';
        container.style.gridTemplateColumns = '280px 1fr';
        button.classList.remove('library-book__btn--active');
    } else {
        tocSidebar.style.display = 'none';
        container.style.gridTemplateColumns = '1fr';
        button.classList.add('library-book__btn--active');
    }
}

function selectParagraph(paragraphId) {
    document.querySelectorAll('.library-book__paragraph').forEach(p => {
        p.classList.remove('library-book__paragraph--selected');
    });

    const paragraph = document.getElementById(paragraphId);
    if (paragraph) {
        paragraph.classList.add('library-book__paragraph--selected');
        selectedParagraph = paragraphId;
        const newUrl = window.location.pathname + window.location.search + '#' + paragraphId;
        history.replaceState(null, null, newUrl);
    }
}

function shareParagraph(paragraphId) {
    const paragraph = document.getElementById(paragraphId);
    if (!paragraph) return;

    let textToCopy = '';
    const translatedText = paragraph.querySelector('.library-book__para-translation');
    const originalText = paragraph.querySelector('.library-book__para-original');

    if (translatedText && translatedText.textContent.trim()) {
        textToCopy = translatedText.textContent.trim();
    } else if (originalText && originalText.textContent.trim()) {
        textToCopy = originalText.textContent.trim();
    }

    if (!textToCopy) return;

    const match = paragraphId.match(/^c(\d+)p(\d+)$/);
    const chapterNum = match ? match[1] : '?';
    const paraNum = match ? match[2] : '?';

    const currentUrl = window.location.origin + window.location.pathname + '#' + paragraphId;
    const shareText = `"${textToCopy}"\n\nâ€” ${bookTitle}, Chapter ${chapterNum}, Paragraph ${paraNum}\n${currentUrl}`;

    if (navigator.share && window.location.protocol === 'https:') {
        navigator.share({
            title: bookTitle + ' - Chapter ' + chapterNum,
            text: shareText,
            url: currentUrl
        }).catch(() => copyToClipboard(shareText));
    } else {
        copyToClipboard(shareText);
    }
}

function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            if (typeof window.showCopySuccess === 'function') window.showCopySuccess();
        }).catch(() => fallbackCopy(text));
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.cssText = 'position:fixed;left:-9999px;top:-9999px';
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        if (typeof window.showCopySuccess === 'function') window.showCopySuccess();
    } catch (err) {}
    document.body.removeChild(textArea);
}

function updateTocHighlight() {
    const tocItems = document.querySelectorAll('.library-book__toc-item');
    const chapters = document.querySelectorAll('.library-book__chapter');
    const paragraphs = document.querySelectorAll('.library-book__paragraph');

    let activeChapter = null;
    let activeParagraph = null;
    const scrollPosition = window.scrollY + 300;

    chapters.forEach(chapter => {
        const chapterTop = chapter.offsetTop;
        const chapterBottom = chapterTop + chapter.offsetHeight;
        if (scrollPosition >= chapterTop && scrollPosition < chapterBottom) {
            activeChapter = chapter.id.replace('chapter-', '');
        }
    });

    paragraphs.forEach(paragraph => {
        const paragraphTop = paragraph.offsetTop;
        const paragraphBottom = paragraphTop + paragraph.offsetHeight;
        if (scrollPosition >= paragraphTop && scrollPosition < paragraphBottom) {
            activeParagraph = paragraph.id;
        }
    });

    tocItems.forEach(item => {
        const chapterNumber = item.dataset.chapter;
        if (chapterNumber === activeChapter) {
            item.classList.add('library-book__toc-item--active');
            currentChapter = parseInt(activeChapter);
        } else {
            item.classList.remove('library-book__toc-item--active');
        }
    });

    updateProgressIndicator(activeChapter, activeParagraph);
    updateChapterNavigation();
}

function updateProgressIndicator(activeChapter, activeParagraphId) {
    const chapterProgress = document.getElementById('chapter-progress');
    const paragraphProgress = document.getElementById('paragraph-progress');

    if (!activeChapter || !chapterProgress || !paragraphProgress) return;

    chapterProgress.textContent = `Chapter ${activeChapter}`;

    if (activeParagraphId) {
        const match = activeParagraphId.match(/^c(\d+)p(\d+)$/);
        if (match) {
            const chapterNum = match[1];
            const paraNum = match[2];
            const currentChapterElement = document.getElementById(`chapter-${chapterNum}`);
            const totalParagraphs = currentChapterElement ?
                currentChapterElement.querySelectorAll('.library-book__paragraph').length : 0;
            paragraphProgress.textContent = `${paraNum}/${totalParagraphs}`;
        }
    }
}

function updateChapterNavigation() {
    const prevButton = document.getElementById('prev-chapter');
    const nextButton = document.getElementById('next-chapter');
    const currentDisplay = document.getElementById('current-chapter-display');

    if (prevButton) prevButton.classList.toggle('library-book__nav-btn--disabled', currentChapter <= 1);
    if (nextButton) nextButton.classList.toggle('library-book__nav-btn--disabled', currentChapter >= totalChapters);
    if (currentDisplay) currentDisplay.textContent = `Chapter ${currentChapter} of ${totalChapters}`;
}

function previousChapter() {
    if (currentChapter > 1) {
        currentChapter--;
        scrollToChapter(currentChapter);
    }
}

function nextChapter() {
    if (currentChapter < totalChapters) {
        currentChapter++;
        scrollToChapter(currentChapter);
    }
}

function scrollToChapter(chapterNumber) {
    const chapter = document.getElementById('chapter-' + chapterNumber);
    if (chapter) {
        chapter.scrollIntoView({ behavior: 'smooth', block: 'start' });
        currentChapter = chapterNumber;
        updateTocHighlight();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Hide original text by default
    toggleOriginalText();

    updateChapterNavigation();

    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(function() {
                updateTocHighlight();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });

    setTimeout(updateTocHighlight, 100);

    // Handle deep linking
    if (window.location.hash) {
        const hashValue = window.location.hash.substring(1);
        if (hashValue.match(/^c\d+p\d+$/)) {
            setTimeout(() => {
                selectParagraph(hashValue);
                document.getElementById(hashValue)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        } else if (hashValue.startsWith('chapter-')) {
            const chapterNumber = hashValue.replace('chapter-', '');
            setTimeout(() => scrollToChapter(parseInt(chapterNumber)), 500);
        }
    }
});
</script>

<!-- Library Reader Scripts -->
<script src="{{ get_url(path='js/library-storage.js') }}"></script>
<script src="{{ get_url(path='js/library-reader.js') }}"></script>
<script src="{{ get_url(path='js/library-study-tools.js') }}"></script>
<script src="{{ get_url(path='js/library-search.js') }}"></script>

{% endblock content %}
