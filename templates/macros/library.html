{# Macro to get the title of a book in the current language #}
{% macro get_book_title(book_data, lang) %}
    {%- if book_data.titles[lang] -%}
        {{ book_data.titles[lang] }}
    {%- elif book_data.titles.en -%}
        {{ book_data.titles.en }}
    {%- else -%}
        {{ book_data.titles[book_data.primaryLang] }}
    {%- endif -%}
{% endmacro %}

{# Macro to get the text of a paragraph in the specified language #}
{% macro get_paragraph_text(paragraph, lang) %}
    {%- if paragraph.i18n and paragraph.i18n[lang] -%}
        {{ paragraph.i18n[lang] }}
    {%- else -%}
        {{ paragraph.text }}
    {%- endif -%}
{% endmacro %}

{# Macro to render a single paragraph with speaker and text #}
{% macro render_paragraph(paragraph, lang, primary_lang) %}
    <div class="paragraph-container" id="para-{{ paragraph.n }}">
        <div class="paragraph-number">{{ paragraph.n }}</div>
        <div class="paragraph-content">
            {% if paragraph.speaker %}
                <div class="speaker-portrait" data-speaker="{{ paragraph.speaker }}">
                    {% set speaker_parts = paragraph.speaker | split(pat=" ") %}
                    {% if speaker_parts | length > 1 %}
                        {{ speaker_parts[0] | truncate(length=1, end="") | upper }}{{ speaker_parts[1] | truncate(length=1, end="") | upper }}
                    {% else %}
                        {{ paragraph.speaker | truncate(length=2, end="") | upper }}
                    {% endif %}
                </div>
            {% endif %}

            <button class="copy-button" onclick="copyParagraph({{ paragraph.n }})" title="Copy paragraph">
                {% include "partials/icons/feather-copy.html" %}
            </button>

            <div class="original-text" data-speaker="{{ paragraph.speaker | default(value='') }}">
                <span class="text">{{ paragraph.text }}</span>
            </div>

            {% if lang != primary_lang and paragraph.i18n and paragraph.i18n[lang] %}
                <div class="translated-text" data-lang="{{ lang }}">
                    <span class="text">{{ self::get_paragraph_text(paragraph=paragraph, lang=detected_lang) }}</span>
                </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Macro to render a chapter with all its paragraphs #}
{% macro render_chapter(chapter, lang, primary_lang) %}
    <section class="chapter" id="chapter-{{ chapter.n }}">
        <header class="chapter-header">
            <h2 class="chapter-title">
                <span class="chapter-number">Chapter {{ chapter.n }}</span>
                {% if chapter.title %}
                    <span class="chapter-name">{{ chapter.title }}</span>
                {% endif %}
            </h2>
        </header>

        <div class="chapter-content">
            {% for paragraph in chapter.paragraphs %}
                {{ self::render_paragraph(paragraph=paragraph, lang=detected_lang, primary_lang=primary_lang) }}
            {% endfor %}
        </div>
    </section>
{% endmacro %}

{# Macro to render chapter navigation #}
{% macro render_chapter_navigation(book_data, current_chapter="", context="book", lang="en") %}
    <nav class="chapter-navigation">
        <div class="chapter-navigation__header">
            <h3 class="chapter-navigation__title">Chapters</h3>
            {% if context == "book" %}
                <button class="original-text-toggle" onclick="toggleOriginalText()" title="Toggle original text">
                    <span class="toggle-icon">ðŸ‡«ðŸ‡·</span>
                    <span class="toggle-text">Original</span>
                </button>
            {% endif %}
        </div>
        <div class="chapter-navigation__buttons">
            {% for chapter in book_data.chapters %}
                {% if context == "book" %}
                    <a href="#chapter-{{ chapter.n }}"
                       class="chapter-navigation__button {% if current_chapter and current_chapter == chapter.n %}chapter-navigation__button--current{% endif %}"
                       onclick="scrollToChapter({{ chapter.n }})"
                       style="--chapter-index: {{ chapter.n }}">
                        {{ chapter.n }}
                    </a>
                {% else %}
                    <a href="{{ get_url(path='library/' ~ book_data.slug, lang=detected_lang) }}#chapter-{{ chapter.n }}"
                       class="chapter-navigation__button"
                       style="--chapter-index: {{ chapter.n }}">
                        {{ chapter.n }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </nav>
{% endmacro %}

{# Macro to render minimal book controls (removed translation controls) #}
{% macro render_book_controls(book_data, current_lang) %}
    <div class="book-controls">
        {{ self::render_chapter_navigation(book_data=book_data, context="book") }}
    </div>
{% endmacro %}

{# Macro to render book metadata #}
{% macro render_book_meta(book_data) %}
    <div class="book-meta">
        {% if book_data.chapters %}
            <span>{{ book_data.chapters | length }} chapters</span>
        {% endif %}
        {% if book_data.updated %}
            <span>Updated: {{ book_data.updated | date(format="%B %d, %Y") }}</span>
        {% endif %}
        {% if book_data.revision %}
            <span>Revision {{ book_data.revision }}</span>
        {% endif %}
    </div>
{% endmacro %}

{# Macro to render a book card for the library index #}
{% macro render_book_card(book_data, lang) %}
    <article class="book-card">
        <div class="book-header">
            <h3>
                <a href="{{ get_url(path='library/' ~ book_data.slug, lang=detected_lang) }}">
                    {{ self::get_book_title(book_data=book_data, lang=detected_lang) }}
                </a>
            </h3>
            {% if book_data.primaryLang != lang and book_data.titles[book_data.primaryLang] %}
                <p class="book-original-title">
                    Original: {{ book_data.titles[book_data.primaryLang] }}
                </p>
            {% endif %}
        </div>

        <div class="book-meta">
            {% if book_data.chapters %}
                <span class="chapter-count">{{ book_data.chapters | length }} chapters</span>
            {% endif %}
            {% if book_data.updated %}
                <span class="last-updated">Updated: {{ book_data.updated | date(format="%B %d, %Y") }}</span>
            {% endif %}
        </div>

        <div class="book-languages">
            <span class="available-languages">Available in:</span>
            {% for lang_code, title in book_data.titles %}
                <span class="language-tag" data-lang="{{ lang_code }}">{{ lang_code | upper }}</span>
            {% endfor %}
        </div>

        {{ self::render_chapter_navigation(book_data=book_data, context="section", lang=detected_lang) }}

        {% if book_data.chapters and book_data.chapters[0] and book_data.chapters[0].paragraphs and book_data.chapters[0].paragraphs[0] %}
            <div class="book-preview">
                {% set first_paragraph = book_data.chapters[0].paragraphs[0] %}
                <p class="preview-text">
                    {{ self::get_paragraph_text(paragraph=first_paragraph, lang=detected_lang) | truncate(length=200) }}
                </p>
            </div>
        {% endif %}
    </article>
{% endmacro %}

{# Macro to load and process all library books #}
{% macro get_all_books() %}
    {%- set books = [] -%}
    {# For now, we'll manually add known books. In the future, this can be automated #}
    {%- set book_files = ["the-book-which-tells-the-truth.json"] -%}

    {%- for book_file in book_files -%}
        {%- set book_data = load_data(path="data/library/" ~ book_file, required=false) -%}
        {%- if book_data -%}
            {%- set_global books = books | concat(with=book_data) -%}
        {%- endif -%}
    {%- endfor -%}

    {{ books }}
{% endmacro %}
