{# Macro to get the title of a book in the current language #}
{% macro get_book_title(book_data, lang) %}
    {%- if book_data.titles[lang] -%}
        {{ book_data.titles[lang] }}
    {%- elif book_data.titles.en -%}
        {{ book_data.titles.en }}
    {%- else -%}
        {{ book_data.titles[book_data.primaryLang] }}
    {%- endif -%}
{% endmacro %}

{# Macro to get the text of a paragraph in the specified language #}
{% macro get_paragraph_text(paragraph, lang) %}
    {%- if paragraph.i18n and paragraph.i18n[lang] -%}
        {{ paragraph.i18n[lang] }}
    {%- else -%}
        {{ paragraph.text }}
    {%- endif -%}
{% endmacro %}

{# Macro to render a single paragraph with speaker and text #}
{% macro render_paragraph(paragraph, lang, show_original=false, show_translation=false) %}
    <div class="paragraph-container" id="para-{{ paragraph.n }}">
        <div class="paragraph-number">{{ paragraph.n }}</div>
        <div class="paragraph-content">
            {% if show_original %}
                <div class="original-text" data-speaker="{{ paragraph.speaker | default(value='') }}">
                    {% if paragraph.speaker %}
                        <span class="speaker">{{ paragraph.speaker }}:</span>
                    {% endif %}
                    <span class="text">{{ paragraph.text }}</span>
                </div>
            {% endif %}

            {% if show_translation and paragraph.i18n %}
                <div class="translated-text" data-lang="{{ lang }}">
                    {% if paragraph.speaker %}
                        <span class="speaker">{{ paragraph.speaker }}:</span>
                    {% endif %}
                    <span class="text">{{ self::get_paragraph_text(paragraph=paragraph, lang=lang) }}</span>
                </div>
            {% endif %}

            {# Store all translations in data attributes for JavaScript #}
            {% if paragraph.i18n %}
                {% for trans_lang, trans_text in paragraph.i18n %}
                    <div class="translation-data"
                         data-lang="{{ trans_lang }}"
                         data-text="{{ trans_text }}"
                         style="display: none;"></div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Macro to render a chapter with all its paragraphs #}
{% macro render_chapter(chapter, lang, primary_lang) %}
    <section class="chapter" id="chapter-{{ chapter.n }}">
        <header class="chapter-header">
            <h2 class="chapter-title">
                <span class="chapter-number">Chapter {{ chapter.n }}</span>
                {% if chapter.title %}
                    <span class="chapter-name">{{ chapter.title }}</span>
                {% endif %}
            </h2>
        </header>

        <div class="chapter-content">
            {% for paragraph in chapter.paragraphs %}
                {{ self::render_paragraph(paragraph=paragraph, lang=lang, show_original=true, show_translation=false) }}
            {% endfor %}
        </div>
    </section>
{% endmacro %}

{# Macro to render the book navigation controls #}
{% macro render_book_controls(book_data, current_lang) %}
    <div class="book-controls">
        <div class="language-selector">
            <label for="translation-lang">Translation:</label>
            <select id="translation-lang" onchange="switchTranslation(this.value)">
                <option value="">Show original only</option>
                {% for lang_code, title in book_data.titles %}
                    {% if lang_code != book_data.primaryLang %}
                        <option value="{{ lang_code }}" {% if lang_code == current_lang %}selected{% endif %}>
                            {{ lang_code | upper }} - {{ title }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="view-controls">
            <button id="toggle-side-by-side" onclick="toggleSideBySide()">
                Side-by-side view
            </button>
        </div>
    </div>
{% endmacro %}

{# Macro to render book metadata #}
{% macro render_book_meta(book_data) %}
    <div class="book-meta">
        {% if book_data.chapters %}
            <span>{{ book_data.chapters | length }} chapters</span>
        {% endif %}
        {% if book_data.updated %}
            <span>Updated: {{ book_data.updated | date(format="%B %d, %Y") }}</span>
        {% endif %}
        {% if book_data.revision %}
            <span>Revision {{ book_data.revision }}</span>
        {% endif %}
    </div>
{% endmacro %}

{# Macro to render a book card for the revelations index #}
{% macro render_book_card(book_data, lang) %}
    <article class="book-card">
        <div class="book-header">
            <h3>
                <a href="{{ get_url(path='revelations/' ~ book_data.slug) }}">
                    {{ self::get_book_title(book_data=book_data, lang=lang) }}
                </a>
            </h3>
            {% if book_data.primaryLang != lang and book_data.titles[book_data.primaryLang] %}
                <p class="book-original-title">
                    Original: {{ book_data.titles[book_data.primaryLang] }}
                </p>
            {% endif %}
        </div>

        <div class="book-meta">
            {% if book_data.chapters %}
                <span class="chapter-count">{{ book_data.chapters | length }} chapters</span>
            {% endif %}
            {% if book_data.updated %}
                <span class="last-updated">Updated: {{ book_data.updated | date(format="%B %d, %Y") }}</span>
            {% endif %}
        </div>

        <div class="book-languages">
            <span class="available-languages">Available in:</span>
            {% for lang_code, title in book_data.titles %}
                <span class="language-tag" data-lang="{{ lang_code }}">{{ lang_code | upper }}</span>
            {% endfor %}
        </div>

        {% if book_data.chapters and book_data.chapters[0] and book_data.chapters[0].paragraphs and book_data.chapters[0].paragraphs[0] %}
            <div class="book-preview">
                {% set first_paragraph = book_data.chapters[0].paragraphs[0] %}
                <p class="preview-text">
                    {{ self::get_paragraph_text(paragraph=first_paragraph, lang=lang) | truncate(length=200) }}
                </p>
            </div>
        {% endif %}
    </article>
{% endmacro %}

{# Macro to load and process all revelation books #}
{% macro get_all_books() %}
    {%- set books = [] -%}
    {# For now, we'll manually add known books. In the future, this can be automated #}
    {%- set book_files = ["the-book-which-tells-the-truth.json"] -%}

    {%- for book_file in book_files -%}
        {%- set book_data = load_data(path="data/revelations/" ~ book_file, required=false) -%}
        {%- if book_data -%}
            {%- set_global books = books | concat(with=book_data) -%}
        {%- endif -%}
    {%- endfor -%}

    {{ books }}
{% endmacro %}
