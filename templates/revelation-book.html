{% extends "base.html" %}
{% import "macros/revelations.html" as revelations_macros %}

{% block content %}
<div class="revelation-book">
    {% set book_slug = page.slug %}
    {% set book_data = load_data(path="data/revelations/" ~ book_slug ~ ".json") %}

    {% if book_data %}
        <header class="book-header">
            <div class="book-title-section">
                <h1 class="book-title">
                    {% if book_data.titles[lang] %}
                        {{ book_data.titles[lang] }}
                    {% elif book_data.titles.en %}
                        {{ book_data.titles.en }}
                    {% else %}
                        {{ book_data.titles[book_data.primaryLang] }}
                    {% endif %}
                </h1>

                {% if book_data.primaryLang != lang and book_data.titles[book_data.primaryLang] %}
                    <p class="original-title">{{ book_data.titles[book_data.primaryLang] }}</p>
                {% endif %}
            </div>

            {{ revelations_macros::render_book_controls(book_data=book_data, current_lang=lang) }}
            {{ revelations_macros::render_book_meta(book_data=book_data) }}
        </header>

        <main class="book-content" id="book-content" data-lang="{{ lang }}">
            {% for chapter in book_data.chapters %}
                {{ revelations_macros::render_chapter(chapter=chapter, lang=lang, primary_lang=book_data.primaryLang) }}
            {% endfor %}
        </main>

        <nav class="book-navigation">
            <a href="{{ get_url(path="revelations") }}" class="back-to-revelations">
                ← Back to Revelations
            </a>
        </nav>

    {% else %}
        <div class="book-not-found">
            <h1>Book Not Found</h1>
            <p>The requested revelation book could not be found.</p>
            <a href="{{ get_url(path="revelations") }}">← Back to Revelations</a>
        </div>
    {% endif %}
</div>



<script>
function switchTranslation(langCode) {
    const paragraphContainers = document.querySelectorAll('.paragraph-container');

    paragraphContainers.forEach(container => {
        const originalText = container.querySelector('.original-text');
        let translatedText = container.querySelector('.translated-text');
        const translationData = container.querySelectorAll('.translation-data');

        // Remove existing translated text if it exists
        if (translatedText) {
            translatedText.remove();
        }

        if (!langCode) {
            // Show only original text
            return;
        }

        // Find the translation for the selected language
        let translationFound = false;
        translationData.forEach(data => {
            if (data.dataset.lang === langCode) {
                translationFound = true;

                // Create new translated text element
                const translatedDiv = document.createElement('div');
                translatedDiv.className = 'translated-text';
                translatedDiv.dataset.lang = langCode;

                // Get speaker from original if it exists
                const originalSpeaker = originalText.querySelector('.speaker');
                if (originalSpeaker) {
                    const speakerSpan = document.createElement('span');
                    speakerSpan.className = 'speaker';
                    speakerSpan.textContent = originalSpeaker.textContent;
                    translatedDiv.appendChild(speakerSpan);
                }

                // Add the translated text
                const textSpan = document.createElement('span');
                textSpan.className = 'text';
                textSpan.textContent = data.dataset.text;
                translatedDiv.appendChild(textSpan);

                // Insert the translated text after the original
                const paragraphContent = container.querySelector('.paragraph-content');
                paragraphContent.appendChild(translatedDiv);
            }
        });
    });
}

function toggleSideBySide() {
    const revelationBook = document.querySelector('.revelation-book');
    const button = document.getElementById('toggle-side-by-side');
    const translationSelect = document.getElementById('translation-lang');

    if (revelationBook.classList.contains('side-by-side')) {
        revelationBook.classList.remove('side-by-side');
        button.textContent = 'Side-by-side view';
        button.classList.remove('active');
    } else {
        revelationBook.classList.add('side-by-side');
        button.textContent = 'Sequential view';
        button.classList.add('active');

        // Automatically show translation if none is selected
        if (!translationSelect.value && translationSelect.options.length > 1) {
            translationSelect.selectedIndex = 1;
            switchTranslation(translationSelect.value);
        }
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    const langSelect = document.getElementById('translation-lang');
    if (langSelect && langSelect.value) {
        switchTranslation(langSelect.value);
    }
});
</script>
{% endblock content %}
