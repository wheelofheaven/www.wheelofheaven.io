{% extends "base.html" %}
{% import "macros/revelations.html" as revelations_macros %}

{% block content %}
<div class="revelation-book">
    {% set book_slug = page.slug %}
    {% set book_data = load_data(path="data/revelations/" ~ book_slug ~ ".json") %}

    {% if book_data %}
        <header class="book-header">
            <div class="book-title-section">
                <h1 class="book-title">
                    {% if book_data.titles[lang] %}
                        {{ book_data.titles[lang] }}
                    {% elif book_data.titles.en %}
                        {{ book_data.titles.en }}
                    {% else %}
                        {{ book_data.titles[book_data.primaryLang] }}
                    {% endif %}
                </h1>

                {% if book_data.primaryLang != lang and book_data.titles[book_data.primaryLang] %}
                    <p class="original-title">{{ book_data.titles[book_data.primaryLang] }}</p>
                {% endif %}
            </div>

            {{ revelations_macros::render_book_meta(book_data=book_data) }}
        </header>

        {{ revelations_macros::render_chapter_navigation(book_data=book_data, context="book") }}

        <main class="book-content" id="book-content" data-lang="{{ lang }}">
            {% for chapter in book_data.chapters %}
                {{ revelations_macros::render_chapter(chapter=chapter, lang=lang, primary_lang=book_data.primaryLang) }}
            {% endfor %}
        </main>

        <nav class="book-navigation">
            <a href="{{ get_url(path="revelations") }}" class="back-to-revelations">
                ← Back to Revelations
            </a>
        </nav>

    {% else %}
        <div class="book-not-found">
            <h1>Book Not Found</h1>
            <p>The requested revelation book could not be found.</p>
            <a href="{{ get_url(path="revelations") }}">← Back to Revelations</a>
        </div>
    {% endif %}
</div>


<script>
function toggleOriginalText() {
    const originalTexts = document.querySelectorAll('.original-text');
    const toggleButton = document.querySelector('.original-text-toggle');
    const isShowing = toggleButton.classList.contains('active');

    originalTexts.forEach(text => {
        if (isShowing) {
            text.classList.remove('show');
        } else {
            text.classList.add('show');
        }
    });

    toggleButton.classList.toggle('active');
}

function selectParagraph(paragraphNumber) {
    // Remove selection from all paragraphs
    document.querySelectorAll('.paragraph-container').forEach(p => {
        p.classList.remove('selected');
    });

    // Select the clicked paragraph
    const paragraph = document.getElementById('para-' + paragraphNumber);
    if (paragraph) {
        paragraph.classList.add('selected');
    }
}

function copyParagraph(paragraphNumber) {
    const paragraph = document.getElementById('para-' + paragraphNumber);
    if (!paragraph) {
        console.error('Paragraph not found:', paragraphNumber);
        return;
    }

    let textToCopy = '';
    let speaker = '';
    let mainText = '';

    // Get speaker from portrait or original text data attribute
    const speakerPortrait = paragraph.querySelector('.speaker-portrait');
    const originalTextEl = paragraph.querySelector('.original-text');

    if (speakerPortrait) {
        speaker = speakerPortrait.getAttribute('data-speaker');
    } else if (originalTextEl) {
        speaker = originalTextEl.getAttribute('data-speaker');
    }

    // Add speaker if present
    if (speaker && speaker.trim()) {
        textToCopy += speaker + ': ';
    }

    // Get the main text - prefer translated, fall back to original
    const translatedTextEl = paragraph.querySelector('.translated-text .text');
    const originalTextSpan = paragraph.querySelector('.original-text .text');

    if (translatedTextEl && translatedTextEl.textContent) {
        mainText = translatedTextEl.textContent.trim();
    } else if (originalTextSpan && originalTextSpan.textContent) {
        mainText = originalTextSpan.textContent.trim();
    }

    if (!mainText) {
        console.error('No text found in paragraph:', paragraphNumber);
        alert('No text to copy');
        return;
    }

    textToCopy += mainText;
    textToCopy += ` (¶${paragraphNumber})`;

    console.log('Copying text:', textToCopy);

    navigator.clipboard.writeText(textToCopy).then(() => {
        // Show copy feedback
        const copyButton = paragraph.querySelector('.copy-button');
        if (copyButton) {
            const originalHTML = copyButton.innerHTML;
            copyButton.innerHTML = '<span style="color: green; font-weight: bold;">✓</span>';
            setTimeout(() => {
                copyButton.innerHTML = originalHTML;
            }, 1500);
        }
        console.log('Text copied successfully');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            document.body.removeChild(textArea);
            console.log('Text copied using fallback method');
        } catch (fallbackErr) {
            document.body.removeChild(textArea);
            console.error('Fallback copy failed:', fallbackErr);
            alert('Failed to copy text to clipboard');
        }
    });
}

function scrollToChapter(chapterNumber) {
    const chapter = document.getElementById('chapter-' + chapterNumber);
    if (chapter) {
        // Smooth scroll to chapter with offset for sticky navigation
        const yOffset = -120;
        const y = chapter.getBoundingClientRect().top + window.pageYOffset + yOffset;
        window.scrollTo({top: y, behavior: 'smooth'});

        // Update active chapter button
        updateActiveChapterButton(chapterNumber);
    }
}

function updateActiveChapterButton(activeChapter) {
    document.querySelectorAll('.chapter-navigation__button').forEach(btn => {
        btn.classList.remove('chapter-navigation__button--current');
        const href = btn.getAttribute('href');
        if (href && href.includes('chapter-' + activeChapter)) {
            btn.classList.add('chapter-navigation__button--current');
        }
    });
}

// Highlight current chapter in navigation as user scrolls
function updateActiveChapter() {
    const chapters = document.querySelectorAll('.chapter');
    if (!chapters.length) return;

    let currentChapter = null;
    const scrollPosition = window.scrollY + 180; // offset for sticky nav

    chapters.forEach(chapter => {
        const chapterTop = chapter.offsetTop;
        const chapterBottom = chapterTop + chapter.offsetHeight;

        if (scrollPosition >= chapterTop && scrollPosition < chapterBottom) {
            currentChapter = chapter.id.replace('chapter-', '');
        }
    });

    if (currentChapter) {
        updateActiveChapterButton(currentChapter);
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Set up scroll listener for chapter highlighting
    let ticking = false;

    function handleScroll() {
        if (!ticking) {
            requestAnimationFrame(function() {
                updateActiveChapter();
                ticking = false;
            });
            ticking = true;
        }
    }

    window.addEventListener('scroll', handleScroll, { passive: true });

    // Initial chapter highlight
    setTimeout(updateActiveChapter, 100);

    // Handle chapter navigation clicks
    document.querySelectorAll('.chapter-navigation__button').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            const chapterMatch = href.match(/chapter-(\d+)/);
            if (chapterMatch) {
                scrollToChapter(chapterMatch[1]);
            }
        });
    });

    // Handle paragraph selection
    document.querySelectorAll('.paragraph-container').forEach(container => {
        container.addEventListener('click', function(e) {
            // Don't select if clicking on copy button
            if (e.target.classList.contains('copy-button')) {
                return;
            }

            const paragraphNumber = this.id.replace('para-', '');
            selectParagraph(paragraphNumber);
        });
    });
});
</script>
{% endblock content %}
